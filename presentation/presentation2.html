<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.49">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Data Privacy and Anonymization</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="presentation_files/libs/clipboard/clipboard.min.js"></script>
<script src="presentation_files/libs/quarto-html/quarto.js"></script>
<script src="presentation_files/libs/quarto-html/popper.min.js"></script>
<script src="presentation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="presentation_files/libs/quarto-html/anchor.min.js"></script>
<link href="presentation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="presentation_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="presentation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="presentation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="presentation_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Data Privacy and Anonymization</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="6c1c6707" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show python version</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.version)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># show python path</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3.10.12 (main, Nov 20 2023, 15:14:05) [GCC 11.4.0]
['/home/stormbird/Desktop/data-privacy-pres', '/usr/lib/python310.zip', '/usr/lib/python3.10', '/usr/lib/python3.10/lib-dynload', '', '/home/stormbird/.local/lib/python3.10/site-packages', '/usr/local/lib/python3.10/dist-packages', '/usr/lib/python3/dist-packages']</code></pre>
</div>
</div>
<div id="69ec547c" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># download and install python packages</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3b4dfe5b" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install diffprivlib <span class="op">-</span>q</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c4c91ef2" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q numpy pandas matplotlib scikit<span class="op">-</span>learn pandas<span class="op">-</span>profiling phe </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e8f882aa" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.manifold <span class="im">import</span> TSNE</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas.api.types <span class="im">import</span> CategoricalDtype</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> HTML</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffprivlib.models <span class="im">import</span> RandomForestClassifier</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> diffprivlib <span class="im">as</span> dp</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> f1_score, classification_report</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.core.display <span class="im">import</span> HTML, Image</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> IFrame</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas_profiling <span class="im">import</span> ProfileReport</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ModuleNotFoundError</span>                       Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[2], line 9</span>
<span class="ansi-green-fg ansi-bold">      7</span> <span style="font-weight:bold;color:rgb(0,135,0)">from</span> <span style="font-weight:bold;color:rgb(0,0,255)">sklearn</span><span style="font-weight:bold;color:rgb(0,0,255)">.</span><span style="font-weight:bold;color:rgb(0,0,255)">model_selection</span> <span style="font-weight:bold;color:rgb(0,135,0)">import</span> train_test_split
<span class="ansi-green-fg ansi-bold">      8</span> <span style="font-weight:bold;color:rgb(0,135,0)">from</span> <span style="font-weight:bold;color:rgb(0,0,255)">sklearn</span><span style="font-weight:bold;color:rgb(0,0,255)">.</span><span style="font-weight:bold;color:rgb(0,0,255)">decomposition</span> <span style="font-weight:bold;color:rgb(0,135,0)">import</span> PCA
<span class="ansi-green-fg">----&gt; 9</span> <span style="font-weight:bold;color:rgb(0,135,0)">from</span> <span style="font-weight:bold;color:rgb(0,0,255)">diffprivlib</span><span style="font-weight:bold;color:rgb(0,0,255)">.</span><span style="font-weight:bold;color:rgb(0,0,255)">models</span> <span style="font-weight:bold;color:rgb(0,135,0)">import</span> RandomForestClassifier
<span class="ansi-green-fg ansi-bold">     10</span> <span style="font-weight:bold;color:rgb(0,135,0)">import</span> <span style="font-weight:bold;color:rgb(0,0,255)">diffprivlib</span> <span style="font-weight:bold;color:rgb(0,135,0)">as</span> <span style="font-weight:bold;color:rgb(0,0,255)">dp</span>
<span class="ansi-green-fg ansi-bold">     11</span> <span style="font-weight:bold;color:rgb(0,135,0)">from</span> <span style="font-weight:bold;color:rgb(0,0,255)">sklearn</span><span style="font-weight:bold;color:rgb(0,0,255)">.</span><span style="font-weight:bold;color:rgb(0,0,255)">metrics</span> <span style="font-weight:bold;color:rgb(0,135,0)">import</span> f1_score, classification_report

<span class="ansi-red-fg">ModuleNotFoundError</span>: No module named 'diffprivlib'</pre>
</div>
</div>
</div>
<div id="32355121" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># specify all the datatypes of the dataset</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>dtypes <span class="op">=</span> {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"County"</span>: <span class="bu">object</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Gender"</span>: CategoricalDtype(),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Martial_status"</span>: <span class="st">"category"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No_of_dependents"</span>: np.int32,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Age"</span>: np.int32,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tier"</span>: CategoricalDtype(categories<span class="op">=</span>[<span class="st">"Bronze"</span>, <span class="st">"Silver"</span>, <span class="st">"Gold"</span>],</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                             ordered<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Policy_limit"</span>: np.float32,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Illness_category"</span>: <span class="st">"category"</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Updated_subscription"</span>: <span class="bu">object</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Updated_subscription"</span>: <span class="bu">object</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Account_withdrawal"</span>: <span class="bu">object</span>,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Retention"</span>: np.int32,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ID_number"</span>: np.int32,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tax_id"</span>: <span class="bu">object</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>dtypes2 <span class="op">=</span> {</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Instrument"</span>: <span class="bu">object</span>,</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Reading"</span>: <span class="bu">object</span>,</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Observation"</span>: np.float32,</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Status"</span>: <span class="st">"category"</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3400f7da" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load all the datasets and specify the arguments to making parsing easier</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>insurance_df <span class="op">=</span> pd.read_csv(<span class="st">"data/Insurance_data_ke.csv"</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                           index_col<span class="op">=</span><span class="st">"id"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                           parse_dates<span class="op">=</span>[<span class="st">"Date_of_entry"</span>],</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                           dtype<span class="op">=</span>dtypes)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>anonymous_df <span class="op">=</span> pd.read_csv(<span class="st">"data/Insurance_data_ke.csv"</span>, header<span class="op">=</span><span class="va">None</span>, skiprows<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>spo2_temp_hr_df <span class="op">=</span> pd.read_csv(<span class="st">"data/Organs.csv"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                              parse_dates<span class="op">=</span>[<span class="st">"Date"</span>],</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                              dtype<span class="op">=</span>dtypes2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Thank the audience for coming and I will go through it in a breeze. TGIF activities and joining them.</p>
<p>What Iâ€™ll talk about: * Definitions * Techniques: * Data Deletion! * Masking &amp; Sampling * Privacy Models: K-anonymity, PCA and Differential privacy</p>
<section id="data-privacy" class="level2">
<h2 class="anchored" data-anchor-id="data-privacy">Data Privacy</h2>
<p><a href="https://www.cloudflare.com/en-gb/learning/privacy/what-is-data-privacy/">Is the protection of personal data from those who should not have access to it and the ability of individuals to determine who can access their personal information.</a></p>
<p>Authorized, fair, and legitimate processing of personal information. Credit: <em>Michelle Dennedy, Jonathan Fox, Tom Finneran, The Privacy Engineerâ€™s Manifesto (Apress, 2014), p.&nbsp;34.</em></p>
<p><img src="https://i.kym-cdn.com/entries/icons/original/000/002/144/You_Shall_Not_Pass!_0-1_screenshot.jpg" alt="Gandalf: the gatekeeper knowyourmeme" width="500" height="500/"></p>
<p><strong>Personally identifiable information (PIIs)</strong></p>
<p><strong>Sensitive PIIs</strong> - info that can be directly linked to a person e.g <strong>biometric data</strong>, <strong>genetic data</strong>, <strong>health status</strong>, <strong>family details</strong>, <strong>National ID number</strong>, <strong>Passport number</strong>, <strong>KRA pin</strong></p>
<p><strong>Non-sensitive PIIs</strong>- info canâ€™t be directly linked to a person as an example <strong>birthday</strong>, <strong>county of origin</strong></p>
<p><strong>Quasi-identifying</strong> - on their own they are not identifying but when combined can be. <strong>Latanya Sweeney</strong> confirmed that combining birth dates, gender and postcodes can be used to identify people in the United States. She also discovered something interesting with her name. Find out. What about Kenya?</p>
<p><strong>Anonymization</strong></p>
<p>Removing PIIs in datasets to keep the individuals Jane/John Does.</p>
<p><img src="https://images.unsplash.com/photo-1646106842476-70e9dc6039f4?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1470&amp;q=80" alt="Photo by Markus Winkler" width="500" height="500/"></p>
</section>
<section id="why-should-we-care" class="level1">
<h1>Why should we care?</h1>
<p><img src="https://www.ftc.gov/sites/default/files/u52513/fb-socmed-tw-1200x600-pen.png" alt="Uber, Meta and Equifax fines" width="500" height="500/"></p>
<p><a href="https://en.wikipedia.org/wiki/2017_Equifax_data_breach">Equifax data breach in 2017</a>, <a href="https://ico.org.uk/about-the-ico/media-centre/news-and-blogs/2020/10/ico-fines-british-airways-20m-for-data-breach-affecting-more-than-400-000-customers/">British Airways Â£20m for data breach affecting more than 400,000 customers</a>, <a href="https://www.reuters.com/article/us-uber-databreach-idUSKCN1M62AJ">Uber to pay $148 million to settle data breach cover-up with U.S. states</a> and <a href="https://www.ftc.gov/news-events/news/press-releases/2019/07/ftc-imposes-5-billion-penalty-sweeping-new-privacy-restrictions-facebook">facebook 5 billion dollar penalty</a></p>
<p><a href="https://www.clydeco.com/en/insights/2023/10/data-protection-compliance-in-kenya-odpc">Oppo Kenya was penalized by ODPC for infringing the Data Protection Act, 2019 by publishing unauthorized photographs of data subjects in their promotional materials</a></p>
<p><a href="https://iapp.org/news/b/kenyas-odpc-issues-kes9-375m-in-data-protection-fines">Kenyaâ€™s Office of the Data Privacy Commissioner announced three penalties totaling KES9,375,000 for alleged violations of the Data Protection Act. Each penalty concerns claims of nonconsensual uses of personal data. The largest fine was KES4,550,000 to Roma School for posting pictures of minors without parental consent.</a></p>
<section id="to-comply-with-the-kenya-data-protection-act-and-general-data-protection-regulation." class="level2">
<h2 class="anchored" data-anchor-id="to-comply-with-the-kenya-data-protection-act-and-general-data-protection-regulation.">To comply with the Kenya data protection Act and General Data Protection Regulation.</h2>
<div id="a0ef41e5" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>IFrame(<span class="st">"Kenya Data Protection Act - Quick Guide 2021.pdf"</span>, width<span class="op">=</span><span class="dv">350</span>, height<span class="op">=</span><span class="dv">250</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">

        <iframe width="350" height="250" src="Kenya Data Protection Act - Quick Guide 2021.pdf" frameborder="0" allowfullscreen=""></iframe>
        
</div>
</div>
</section>
<section id="data-deletion" class="level2">
<h2 class="anchored" data-anchor-id="data-deletion">Data Deletion</h2>
<p><img src="https://c.tenor.com/En0FRnXFEBsAAAAC/self-destruct-inspector-gadget.gif" alt="GIF by ThisguyFawkes" width="500" height="500/"></p>
<p>Plan for it:<br>
* Come up with a data inventory and control access<br>
* Follow that up with a segregation strategy: Operational data (10 months) and archival data (5 years) * Create a Retriever(): Gets all the data regarding a specific client. Itâ€™s their right. * Create a Destroyer(): Deletes all data regarding a customer from every store e.g database, object storage(object expiration) et cetera * Make a privacy engineering team to handle these.</p>
<a href="https://imgflip.com/i/6so56t"><img width="250" height="250" src="https://i.imgflip.com/6so56t.jpg" title="made at imgflip.com"> </a>
<div>
<a href="https://imgflip.com/memegenerator">from Imgflip Meme Generator </a>
</div>
<p>Enter the matrix ðŸ˜Ž</p>
<a href="https://imgflip.com/i/6so6pp"><img width="500" height="500" src="https://i.imgflip.com/6so6pp.jpg" title="made at imgflip.com"></a>
<div>
<a href="https://imgflip.com/memegenerator">from Imgflip Meme Generator</a>
</div>
</section>
<section id="compare-datasets" class="level2">
<h2 class="anchored" data-anchor-id="compare-datasets">Compare Datasets</h2>
<p>Ask if the data is real in their eyes?</p>
<div id="58bc4ad0" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a summary of the data</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>anonymous_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 1001 entries, 0 to 1000
Data columns (total 13 columns):
 #   Column  Non-Null Count  Dtype 
---  ------  --------------  ----- 
 0   0       1001 non-null   int64 
 1   1       1001 non-null   object
 2   2       1001 non-null   object
 3   3       1001 non-null   object
 4   4       1001 non-null   int64 
 5   5       1001 non-null   int64 
 6   6       1001 non-null   object
 7   7       1001 non-null   int64 
 8   8       1001 non-null   object
 9   9       1001 non-null   object
 10  10      1001 non-null   object
 11  11      1001 non-null   object
 12  12      1001 non-null   int64 
dtypes: int64(5), object(8)
memory usage: 101.8+ KB</code></pre>
</div>
</div>
<div id="dd6f99c6" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Masking the data</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>anonymous_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
<th data-quarto-table-cell-role="th">11</th>
<th data-quarto-table-cell-role="th">12</th>
<th data-quarto-table-cell-role="th">13</th>
<th data-quarto-table-cell-role="th">14</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>Machakos</td>
<td>Female</td>
<td>Single</td>
<td>2</td>
<td>47</td>
<td>Silver</td>
<td>300000</td>
<td>Chronic</td>
<td>2013-11-14 01:12:01</td>
<td>No</td>
<td>No</td>
<td>14</td>
<td>38074758</td>
<td>N690674664H</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>Kisii</td>
<td>Male</td>
<td>Married</td>
<td>3</td>
<td>39</td>
<td>Silver</td>
<td>300000</td>
<td>Congenital</td>
<td>2015-09-11 02:32:07</td>
<td>Yes</td>
<td>Yes</td>
<td>5</td>
<td>19503833</td>
<td>F384415788F</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>Marsabit</td>
<td>Female</td>
<td>Widowed</td>
<td>3</td>
<td>73</td>
<td>Bronze</td>
<td>500000</td>
<td>Chronic</td>
<td>2000-11-24 04:13:56</td>
<td>Yes</td>
<td>No</td>
<td>2</td>
<td>5985350</td>
<td>B871536581P</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3</td>
<td>Kilifi</td>
<td>Male</td>
<td>Separated</td>
<td>4</td>
<td>52</td>
<td>Gold</td>
<td>300000</td>
<td>Congenital</td>
<td>2006-04-06 12:50:18</td>
<td>No</td>
<td>No</td>
<td>19</td>
<td>23029320</td>
<td>P464662008O</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>4</td>
<td>Marsabit</td>
<td>Female</td>
<td>Married</td>
<td>5</td>
<td>39</td>
<td>Silver</td>
<td>300000</td>
<td>Subacute</td>
<td>2016-12-04 16:49:07</td>
<td>Yes</td>
<td>No</td>
<td>9</td>
<td>22372093</td>
<td>V172966182A</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="masking" class="level2">
<h2 class="anchored" data-anchor-id="masking">Masking</h2>
<a href="https://imgflip.com/i/6tzu9y"><img width="250" height="250" src="https://i.imgflip.com/6tzu9y.jpg" title="made at imgflip.com"></a>
<div>
<a href="https://imgflip.com/memegenerator">from Imgflip Meme Generator</a>
</div>
<div id="806587cc" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>insurance_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Int64Index: 1001 entries, 0 to 1000
Data columns (total 12 columns):
 #   Column                Non-Null Count  Dtype         
---  ------                --------------  -----         
 0   County                1001 non-null   object        
 1   Gender                1001 non-null   category      
 2   Marital_status        1001 non-null   object        
 3   No_of_dependents      1001 non-null   int32         
 4   Age                   1001 non-null   int32         
 5   Tier                  1001 non-null   category      
 6   Policy_limit          1001 non-null   float32       
 7   Illness_category      1001 non-null   category      
 8   Date_of_entry         1001 non-null   datetime64[ns]
 9   Updated_subscription  1001 non-null   object        
 10  Account_withdrawal    1001 non-null   object        
 11  Retention             1001 non-null   int32         
dtypes: category(3), datetime64[ns](1), float32(1), int32(3), object(4)
memory usage: 65.8+ KB</code></pre>
</div>
</div>
<div id="40621843" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;skip&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use pandas profiling for EDA of the dataset</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>profile <span class="op">=</span> ProfileReport(insurance_df, title<span class="op">=</span><span class="st">"Pandas Profiling Report of the KE insurance company"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>profile.to_file(<span class="st">"insurance_report.html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[3], line 2</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># Use pandas profiling for EDA of the dataset</span>
<span class="ansi-green-fg">----&gt; 2</span> profile <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">ProfileReport</span>(insurance_df, title<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Pandas Profiling Report of the KE insurance company</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">      3</span> profile<span style="color:rgb(98,98,98)">.</span>to_file(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">insurance_report.html</span><span style="color:rgb(175,0,0)">"</span>)

<span class="ansi-red-fg">NameError</span>: name 'ProfileReport' is not defined</pre>
</div>
</div>
</div>
</section>
<section id="switch-to-html-report" class="level2">
<h2 class="anchored" data-anchor-id="switch-to-html-report">Switch to HTML report</h2>
<p>#HTML(filename=â€˜insurance_report.htmlâ€™)</p>
<div id="c6eb4710" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remove columns that are very particular</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">#insurance_df = insurance_df.drop(["ID_number", "Tax_id"], axis=1)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d91d245b" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># see what columns were left</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>insurance_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>Index(['County', 'Gender', 'Marital_status', 'No_of_dependents', 'Age', 'Tier',
       'Policy_limit', 'Illness_category', 'Date_of_entry',
       'Updated_subscription', 'Account_withdrawal', 'Retention'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="sampling" class="level2">
<h2 class="anchored" data-anchor-id="sampling">Sampling</h2>
<p>Taking a subset of the data and calculating a metric on the data for example mean, median, count. <img src="https://images.unsplash.com/photo-1636647511603-f46efb36c327?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1103&amp;q=80" alt="Photo by Douglas Fehr" width="500" height="500/"></p>
<div id="ec000cea" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a subset of the dataframe</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>insurance_df_sample <span class="op">=</span> insurance_df.sample(n<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3c141f21" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># finding unique items in the pandas Series and return a probability</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>insurance_df[<span class="st">'Marital_status'</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>Separated                 0.375624
Single                    0.272727
Married                   0.204795
Widowed                   0.138861
Registered Partnership    0.006993
Divorced                  0.000999
Name: Marital_status, dtype: float64</code></pre>
</div>
</div>
<div id="69defd82" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>mar_status_counts <span class="op">=</span> insurance_df_sample[<span class="st">'Marital_status'</span>].value_counts(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>mar_status_counts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>Separated    0.35
Married      0.28
Single       0.21
Widowed      0.16
Name: Marital_status, dtype: float64</code></pre>
</div>
</div>
<div id="f6d3a679" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a non random sample distribution based on the original dataset</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>insurance_df_sample[<span class="st">"Martial_status"</span>] <span class="op">=</span> np.random.choice(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    mar_status_counts.index,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    p<span class="op">=</span>mar_status_counts.values,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span><span class="bu">len</span>(insurance_df_sample))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c40dcd12" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>insurance_df_sample[<span class="st">'Martial_status'</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>Separated    0.38
Single       0.22
Married      0.21
Widowed      0.19
Name: Martial_status, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="k-anonymity" class="level2">
<h2 class="anchored" data-anchor-id="k-anonymity">K-anonymity</h2>
<p>Reducing distinction between groups. K groups share properties.</p>
<a href="https://imgflip.com/i/6ue60m"><img width="500" height="500" src="https://i.imgflip.com/6ue60m.jpg" title="made at imgflip.com"></a>
<div>
<a href="https://imgflip.com/memegenerator">from Imgflip Meme Generator</a>
</div>
<div id="1b791b2b" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># arrange dataframe by Age and tier, count instances of both and rename the column</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>insurance_df.groupby([<span class="st">"Age"</span>, <span class="st">"Tier"</span>]).size().reset_index(name<span class="op">=</span><span class="st">"Count"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">Tier</th>
<th data-quarto-table-cell-role="th">Count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>30</td>
<td>Bronze</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>30</td>
<td>Silver</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>30</td>
<td>Gold</td>
<td>6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>31</td>
<td>Bronze</td>
<td>9</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>31</td>
<td>Silver</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">130</td>
<td>73</td>
<td>Silver</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">131</td>
<td>73</td>
<td>Gold</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">132</td>
<td>74</td>
<td>Bronze</td>
<td>14</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">133</td>
<td>74</td>
<td>Silver</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">134</td>
<td>74</td>
<td>Gold</td>
<td>4</td>
</tr>
</tbody>
</table>

<p>135 rows Ã— 3 columns</p>
</div>
</div>
</div>
<div id="544cb222" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># binning data into at most 4 intervals</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>insurance_df[<span class="st">"Age"</span>] <span class="op">=</span> pd.cut(insurance_df[<span class="st">"Age"</span>], bins<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="28036e95" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># see sample</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>insurance_df[[<span class="st">"Age"</span>, <span class="st">"Tier"</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">Tier</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>(41.0, 52.0]</td>
<td>Silver</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>(29.956, 41.0]</td>
<td>Silver</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>(63.0, 74.0]</td>
<td>Bronze</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>(41.0, 52.0]</td>
<td>Gold</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>(29.956, 41.0]</td>
<td>Silver</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">996</td>
<td>(63.0, 74.0]</td>
<td>Silver</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">997</td>
<td>(29.956, 41.0]</td>
<td>Bronze</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">998</td>
<td>(52.0, 63.0]</td>
<td>Bronze</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">999</td>
<td>(63.0, 74.0]</td>
<td>Gold</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1000</td>
<td>(52.0, 63.0]</td>
<td>Silver</td>
</tr>
</tbody>
</table>

<p>1001 rows Ã— 2 columns</p>
</div>
</div>
</div>
<div id="898a866c" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># redistributes the information</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>insurance_df[<span class="st">"Age"</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>(29.956, 41.0]    0.262737
(52.0, 63.0]      0.258741
(41.0, 52.0]      0.252747
(63.0, 74.0]      0.225774
Name: Age, dtype: float64</code></pre>
</div>
</div>
<div id="bdde471d" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many specific groups arise should not be 4</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>count_groups <span class="op">=</span> insurance_df.groupby([<span class="st">"Age"</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">"Tier"</span>]).size().reset_index(name<span class="op">=</span><span class="st">"Count"</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>count_groups[count_groups[<span class="st">'Count'</span>] <span class="op">&lt;</span> k]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">Tier</th>
<th data-quarto-table-cell-role="th">Count</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="differential-privacy" class="level2">
<h2 class="anchored" data-anchor-id="differential-privacy">Differential Privacy</h2>
<p>Adding statistical noise to your work. Governed by an epsilon parameter which is the <strong>privacy budget</strong>.</p>
<a href="https://imgflip.com/i/6tc4hy"><img width="500" height="500" src="https://i.imgflip.com/6tc4hy.jpg" title="made at imgflip.com"></a>
<div>
<a href="https://imgflip.com/memegenerator">from Imgflip Meme Generator</a>
</div>
<p>Would you want someone knowing that you have Diabetes insipidus or what is the staple food in Kenya? Low values give less accurate data whereas high values give the most accurate data. How you can add noise resample your data and decide to remove outliers or just multiple the same outlier with a random number maybe sampled from a normal distribution.</p>
<div id="7d992641" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make 10 random numbers</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.random.randint(<span class="dv">1</span>, <span class="dv">10</span>, size<span class="op">=</span><span class="dv">10</span>, dtype<span class="op">=</span>np.int32)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># specify budget accountant, adjust value to be 10 and see the difference</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> dp.BudgetAccountant(epsilon<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co"># find the mean</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(X)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Then mean of your array is"</span>,</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>      dp.tools.mean(X, bounds<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">9</span>), accountant<span class="op">=</span>acc),</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">",Using the normal mean function"</span>, {np.mean(X)})</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Budget so far "</span>, acc.remaining())  <span class="co"># how much you have spen</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[6 9 6 1 1 2 8 7 3 5]
Then mean of your array is 4.6072488508630265 ,Using the normal mean function {4.8}
Budget so far  (epsilon=1.1102230246251565e-16, delta=1.0)</code></pre>
</div>
</div>
<div id="72e48678" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add this example if someone says they don't get it</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># multiply 2 numbers with a random number sampled from a normal distribution &amp; then do a mean</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">#X[1] = X[1] * np.random.normal()</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">#X[9] = X[9] * np.random.normal()</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co"># multiply each number with a number sampled from the normal distribution &amp; then do a mean</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co"># X * np.random.normal() # add noise</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># X = np.delete(X, [9, 1], 0) # remove the smallest and largest numbers &amp; then do a mean</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co"># np.mean(X)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b6b10c6c" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run it again, should not work</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co">#print(f"Then mean of your array is",</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co">#      {dp.tools.mean(X, bounds=(1, 8), accountant=acc)},</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">#      "Using the normal mean function", {np.mean(X)})</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">#print("Budget so far ", acc.remaining())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="93a898e2" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load dataset into memory</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>feat_eng_df <span class="op">=</span> pd.read_csv(<span class="st">"data/feature_engineered_insurance.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2b8b44e8" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>feat_eng_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>Index(['No_of_dependents', 'Age', 'Policy_limit', 'Retention',
       'Date_of_entryYear', 'Date_of_entryMonth', 'Date_of_entryWeek',
       'Date_of_entryDay', 'Date_of_entryDayofweek', 'Date_of_entryDayofyear',
       'Account_withdrawal=No', 'Account_withdrawal=Yes', 'County=Baringo',
       'County=Bomet', 'County=Bungoma', 'County=Busia',
       'County=Elgeyo-Marakwet', 'County=Embu', 'County=Garissa',
       'County=Homa Bay', 'County=Isiolo', 'County=Kajiado', 'County=Kakamega',
       'County=Kericho', 'County=Kiambu', 'County=Kilifi', 'County=Kirinyaga',
       'County=Kisii', 'County=Kisumu', 'County=Kitui', 'County=Kwale',
       'County=Laikipia', 'County=Lamu', 'County=Machakos', 'County=Makueni',
       'County=Mandera', 'County=Marsabit', 'County=Meru', 'County=Migori',
       'County=Mombasa (County)', 'County=Murang'a', 'County=Nairobi (County)',
       'County=Nakuru', 'County=Nandi', 'County=Narok', 'County=Nyamira',
       'County=Nyandarua', 'County=Nyeri', 'County=Samburu', 'County=Siaya',
       'County=Tana River', 'County=Tharaka-Nithi', 'County=Trans-Nzoia',
       'County=Turkana', 'County=Uasin Gishu', 'County=Vihiga', 'County=Wajir',
       'County=West Pokot', 'Date_of_entryIs_month_end',
       'Date_of_entryIs_month_start', 'Date_of_entryIs_quarter_end',
       'Date_of_entryIs_quarter_start', 'Date_of_entryIs_year_end',
       'Date_of_entryIs_year_start', 'Gender=Female', 'Gender=Male',
       'Illness_category=Acute', 'Illness_category=Chronic',
       'Illness_category=Coegnital', 'Illness_category=Subacute',
       'Marital_status=Divorced', 'Marital_status=Married',
       'Marital_status=Registered Partnership', 'Marital_status=Separated',
       'Marital_status=Single', 'Marital_status=Widowed', 'Tier=Bronze',
       'Tier=Gold', 'Tier=Silver', 'Updated_subscription=No',
       'Updated_subscription=Yes', 'id'],
      dtype='object')</code></pre>
</div>
</div>
<div id="84ce8cc7" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># preparing the matrix and the vector</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Dependent variable/predictors: X and independent variable/Target: If the client is going to stopped using the service</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>feat_eng_df2 <span class="op">=</span> feat_eng_df.drop([<span class="st">"id"</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> feat_eng_df2.to_numpy()</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.random.choice([<span class="dv">0</span>, <span class="dv">1</span>], p<span class="op">=</span>[<span class="fl">0.50</span>, <span class="fl">0.50</span>],</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>                     size<span class="op">=</span><span class="bu">len</span>(feat_eng_df)) </span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>array([0, 1, 0, ..., 0, 1, 1])</code></pre>
</div>
</div>
<div id="4f41aa74" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Review the sample of array</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>(1001, 81)</code></pre>
</div>
</div>
<div id="643ba958" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>(1001,)</code></pre>
</div>
</div>
<div id="7cfc5a97" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model validation strategy: Train test split</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>features_train, features_validation_test, labels_train, labels_validation_test <span class="op">=</span> train_test_split(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    x, y, test_size<span class="op">=</span><span class="fl">0.4</span>, random_state<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>features_validation, features_test, labels_validation, labels_test <span class="op">=</span> train_test_split(</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    features_validation_test,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    labels_validation_test,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    test_size<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="064a2246" class="cell" data-scrolled="false" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify, fit, Predict paradigm</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>clf <span class="op">=</span> RandomForestClassifier(n_jobs<span class="op">=-</span><span class="dv">1</span>, epsilon<span class="op">=</span><span class="fl">0.5</span>, random_state<span class="op">=</span><span class="dv">345</span>, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>clf.fit(features_train, labels_train)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> clf.predict(features_validation_test)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>report <span class="op">=</span> classification_report(labels_validation_test, preds)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(report)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/bens/anaconda3/envs/data-privacy-env/lib/python3.9/site-packages/diffprivlib/models/forest.py:188: PrivacyLeakWarning: `feature_domains` parameter hasn't been specified, so falling back to determining domains from the data.
This may result in additional privacy leakage. To ensure differential privacy with no additional privacy loss, specify `feature_domains` according to the documentation
  warnings.warn(
[Parallel(n_jobs=-1)]: Using backend LokyBackend with 4 concurrent workers.
[Parallel(n_jobs=-1)]: Done  10 out of  10 | elapsed:  5.7min finished
[Parallel(n_jobs=4)]: Using backend ThreadingBackend with 4 concurrent workers.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>              precision    recall  f1-score   support

           0       0.52      0.74      0.61       198
           1       0.57      0.33      0.42       203

    accuracy                           0.53       401
   macro avg       0.54      0.54      0.51       401
weighted avg       0.54      0.53      0.51       401
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Parallel(n_jobs=4)]: Done  10 out of  10 | elapsed:    0.7s finished</code></pre>
</div>
</div>
<p>Random Forest is a machine learning algorithm which uses a couple of DecisionTrees on random subsets of the data. Among all the features in the data, picks the one that best divides the labels.</p>
<p>Precision goal is to limit the number of false positives, Recall/Sensitivity how many of the positive points were correctly predicted by the model. Limit the number of false negatives and F1 score combines recall and the precision.</p>
<p>Use the newer version of diffprivlib to tune it better. Try running getting a model without using diffprivlib.</p>
</section>
<section id="pca" class="level2">
<h2 class="anchored" data-anchor-id="pca">PCA</h2>
<p>Principal component Analysis. Very pervasive technique to reduce the dimensions of any dataset and still retaining the properties of the data. You can also use it for data compression.</p>
<div id="1b66e468" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">#PATH = "~/Desktop/data_privacy_013/"</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>Image(<span class="st">"Screenshot from 2022-09-10 07-03-38.png"</span>,</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>      width<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>      height<span class="op">=</span><span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<div>
<figure class="figure">
<p><img src="presentation_files/figure-html/cell-36-output-1.png" width="500" height="500" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="c28d5358" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dim_reduction(data):</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    pca <span class="op">=</span> PCA(n_components<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pca.fit_transform(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f337b132" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check how much memory in bytes your columns are using</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>feat_eng_df2.memory_usage()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>Index                        128
No_of_dependents            8008
Age                         8008
Policy_limit                8008
Retention                   8008
                            ... 
Tier=Bronze                 8008
Tier=Gold                   8008
Tier=Silver                 8008
Updated_subscription=No     8008
Updated_subscription=Yes    8008
Length: 82, dtype: int64</code></pre>
</div>
</div>
<div id="7ea06551" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># apply pca</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>pca_mat <span class="op">=</span> dim_reduction(feat_eng_df2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7a2a23d7" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="41">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># change the resultant matrix to a dataframe</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>pca_df <span class="op">=</span> pd.DataFrame(pca_mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="86105105" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>pca_df.memory_usage()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>Index     128
0        8008
1        8008
dtype: int64</code></pre>
</div>
</div>
<p>Moved from 82 columns to 2. Notice: the number of bytes in the column resembles that of the original column entries.</p>
</section>
<section id="embeddings" class="level2">
<h2 class="anchored" data-anchor-id="embeddings">Embeddings</h2>
<p>Embeddings are a way to represent data in a lower dimension. They consist of a vector of numbers that represent the data. They are used in Natural Language Processing, Computer Vision and Recommendation Systems. They are commonly used in the transformer architecture. To get a representation of data.</p>
<p>Examples include Word2Vec, GloVe, and FastText. Weâ€™ll use numpy to create embeddings for our data. Then use T-SNE to visualize the embeddings. It keep things that are close in high dimensions close in 2D or 3D as well.</p>
<div id="b214c6a2" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the categorical variables</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co"># NB: The order of the categories is important for the embeddings and the duplicate values are intentional</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>gender <span class="op">=</span> np.array([<span class="st">'Male'</span>, <span class="st">'Female'</span>, <span class="st">'Male'</span>, <span class="st">'Female'</span>])</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>occupation <span class="op">=</span> np.array([<span class="st">'Engineer'</span>, <span class="st">'Doctor'</span>, <span class="st">'Teacher'</span>, <span class="st">'Engineer'</span>])</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>education_level <span class="op">=</span> np.array([<span class="st">'Bachelor'</span>, <span class="st">'Doctorate'</span>, <span class="st">'Masters'</span>, <span class="st">'Bachelor'</span>])</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co"># The dimensionality of the embedding vectors</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>embedding_dim <span class="op">=</span> <span class="dv">3</span>  </span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate random embeddings</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_embeddings(categories:<span class="bu">str</span>, embedding_dim:<span class="bu">int</span>):</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate random embeddings for categorical variables.</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a><span class="co">    categories : str</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Array of categorical variables.</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a><span class="co">    embedding_dim : int</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a><span class="co">        The dimensionality of the embedding vectors.</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a><span class="co">    dict</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a><span class="co">        A dictionary where the keys are the unique categories from the input </span></span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a><span class="co">        and the values are the corresponding embeddings.</span></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a><span class="co">    Example</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; categories = np.array(['Male', 'Female'])</span></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; embedding_dim = 3</span></span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; embeddings = generate_embeddings(categories, embedding_dim)</span></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; print(embeddings)</span></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a><span class="co">    {'Male': array([0.1, 0.2, 0.3]), 'Female': array([0.4, 0.5, 0.6])}</span></span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>    category_embeddings <span class="op">=</span> {}</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> category <span class="kw">in</span> np.unique(categories):</span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>        category_embeddings[category] <span class="op">=</span> np.random.rand(embedding_dim)</span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> category_embeddings</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Create embeddings for the categorical variables</span></span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>gender_embedding <span class="op">=</span> generate_embeddings(gender, embedding_dim)</span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>occupation_embedding <span class="op">=</span> generate_embeddings(occupation, embedding_dim)</span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>education_embedding <span class="op">=</span> generate_embeddings(education_level, embedding_dim)</span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Encode the categorical variables using embeddings</span></span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the category in the dictionary and use it to get the corresponding embedding</span></span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>encoded_gender <span class="op">=</span> gender_embedding[gender[<span class="dv">0</span>]]</span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>encoded_occupation <span class="op">=</span> occupation_embedding[occupation[<span class="dv">0</span>]]</span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>encoded_education_level <span class="op">=</span> education_embedding[education_level[<span class="dv">0</span>]]</span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all embeddings into a single array for t-SNE</span></span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> np.array(<span class="bu">list</span>(gender_embedding.values()) <span class="op">+</span> <span class="bu">list</span>(occupation_embedding.values()) <span class="op">+</span> <span class="bu">list</span>(education_embedding.values()))</span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the encoded values</span></span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Encoded Gender:"</span>, encoded_gender)</span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Encoded Occupation:"</span>, encoded_occupation)</span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Encoded Education Level:"</span>, encoded_education_level)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoded Gender: [0.11183795 0.4517675  0.33624615]
Encoded Occupation: [0.0153379  0.36029145 0.26005155]
Encoded Education Level: [0.53302015 0.86031051 0.83079   ]</code></pre>
</div>
</div>
<p>This is how we can use embeddings to represent data in a numerical form. Besides, without the labels, we donâ€™t know what the data is about. You can use this to cluster the data and see if you can get some insights from it. Letâ€™s try to cluster the data and see if we can get some insights from it.</p>
<div id="69d8be76" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Categories for labeling in the plot</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>categories <span class="op">=</span> <span class="bu">list</span>(gender_embedding.keys()) <span class="op">+</span> <span class="bu">list</span>(occupation_embedding.keys()) <span class="op">+</span> <span class="bu">list</span>(education_embedding.keys())</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>category_labels <span class="op">=</span> [<span class="st">'Gender'</span>] <span class="op">*</span> <span class="bu">len</span>(gender_embedding) <span class="op">+</span> [<span class="st">'Occupation'</span>] <span class="op">*</span> <span class="bu">len</span>(occupation_embedding) <span class="op">+</span> [<span class="st">'Education'</span>] <span class="op">*</span> <span class="bu">len</span>(education_embedding)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {<span class="st">'Gender'</span>: <span class="st">'red'</span>, <span class="st">'Occupation'</span>: <span class="st">'blue'</span>, <span class="st">'Education'</span>: <span class="st">'green'</span>}</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply t-SNE for dimensionality reduction</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co"># n_components: The number of dimensions to reduce to.</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co"># perplexity: The number of nearest neighbors to consider.</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>tsne <span class="op">=</span> TSNE(n_components<span class="op">=</span><span class="dv">2</span>, perplexity<span class="op">=</span><span class="dv">3</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>embeddings_2d <span class="op">=</span> tsne.fit_transform(embeddings)</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the embeddings in 2D space</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>))</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, category <span class="kw">in</span> <span class="bu">enumerate</span>(categories):</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>    plt.scatter(embeddings_2d[i, <span class="dv">0</span>], embeddings_2d[i, <span class="dv">1</span>], c<span class="op">=</span>colors[category_labels[i]], label<span class="op">=</span>category_labels[i] <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> category_labels[i] <span class="op">!=</span> category_labels[i <span class="op">-</span> <span class="dv">1</span>] <span class="cf">else</span> <span class="st">""</span>)</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotate the points with labels</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, txt <span class="kw">in</span> <span class="bu">enumerate</span>(categories):</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>    plt.annotate(txt, (embeddings_2d[i, <span class="dv">0</span>], embeddings_2d[i, <span class="dv">1</span>]), fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Dimension 1'</span>)</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Dimension 2'</span>)</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'t-SNE Visualization of Random Embeddings'</span>)</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/bens/anaconda3/envs/data-privacy-env/lib/python3.9/site-packages/sklearn/manifold/_t_sne.py:780: FutureWarning: The default initialization in TSNE will change from 'random' to 'pca' in 1.2.
  warnings.warn(
/home/bens/anaconda3/envs/data-privacy-env/lib/python3.9/site-packages/sklearn/manifold/_t_sne.py:790: FutureWarning: The default learning rate in TSNE will change from 200.0 to 'auto' in 1.2.
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="presentation_files/figure-html/cell-43-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>(Note that this will change depending on your data.)</p>
<p>When <em>Engineer</em>, <em>Doctor</em>, and <em>Doctorate</em> are close to each other in the plot, it tells us that these roles share some key features or characteristics in our data. Maybe they all need high education levels or specialized skills.</p>
<p>On the other hand, if <em>Teacher</em> is far from these clustered points, it suggests that being a teacher has different characteristics or features in the data.</p>
<p>Visualization helps us see hidden patterns in our data. For instance, seeing similar roles cluster together can tell us something important about the relationships between these roles, like educational background or job skills.</p>
<p>It helps us understand how our embedding model (which converts categories to numbers) is doing in capturing these patterns.</p>
</section>
<section id="federated-learning" class="level2">
<h2 class="anchored" data-anchor-id="federated-learning">Federated Learning</h2>
<p>Federated learning is a machine learning technique that trains an algorithm across multiple devices or servers holding local data samples, without exchanging them. This approach stands in contrast to traditional centralized machine learning techniques where all data is uploaded to one server.</p>
<p>Weâ€™ll need to download some data from a repository about spam and ham emails. Note: the next cell applies best practices when it comes to getting data from somewhere. Retries, timeouts, and error handling. These will get you far in your data science journey.</p>
<div id="9057c0cd" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span><span class="cf">for</span> i <span class="kw">in</span> {<span class="fl">1..3</span>}<span class="op">;</span> do wget <span class="op">--</span>timeout<span class="op">=</span><span class="dv">300</span> <span class="op">--</span>tries<span class="op">=</span><span class="dv">3</span> https:<span class="op">//</span>github.com<span class="op">/</span>Shuyib<span class="op">/</span>Grokking<span class="op">-</span>Deep<span class="op">-</span>Learning<span class="op">/</span>raw<span class="op">/</span>master<span class="op">/</span>ham.txt <span class="op">-</span>O data<span class="op">/</span>ham.txt <span class="op">&amp;&amp;</span> wget <span class="op">--</span>timeout<span class="op">=</span><span class="dv">300</span> <span class="op">--</span>tries<span class="op">=</span><span class="dv">3</span> https:<span class="op">//</span>github.com<span class="op">/</span>Shuyib<span class="op">/</span>Grokking<span class="op">-</span>Deep<span class="op">-</span>Learning<span class="op">/</span>raw<span class="op">/</span>master<span class="op">/</span>spam.txt <span class="op">-</span>O data<span class="op">/</span>spam.txt <span class="op">&amp;&amp;</span> <span class="cf">break</span> <span class="op">||</span> sleep <span class="dv">5</span><span class="op">;</span> done</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--2024-06-20 10:54:33--  https://github.com/Shuyib/Grokking-Deep-Learning/raw/master/ham.txt
Resolving github.com (github.com)... 20.87.245.0
Connecting to github.com (github.com)|20.87.245.0|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://raw.githubusercontent.com/Shuyib/Grokking-Deep-Learning/master/ham.txt [following]
--2024-06-20 10:54:36--  https://raw.githubusercontent.com/Shuyib/Grokking-Deep-Learning/master/ham.txt
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.110.133, 185.199.108.133, 185.199.109.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.110.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 21180948 (20M) [text/plain]
Saving to: â€˜data/ham.txtâ€™

data/ham.txt        100%[===================&gt;]  20.20M   241KB/s    in 76s     

2024-06-20 10:55:56 (273 KB/s) - â€˜data/ham.txtâ€™ saved [21180948/21180948]

--2024-06-20 10:55:56--  https://github.com/Shuyib/Grokking-Deep-Learning/raw/master/spam.txt
Resolving github.com (github.com)... 20.87.245.0
Connecting to github.com (github.com)|20.87.245.0|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://raw.githubusercontent.com/Shuyib/Grokking-Deep-Learning/master/spam.txt [following]
--2024-06-20 10:55:58--  https://raw.githubusercontent.com/Shuyib/Grokking-Deep-Learning/master/spam.txt
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.111.133, 185.199.109.133, 185.199.108.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.111.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10843548 (10M) [application/octet-stream]
Saving to: â€˜data/spam.txtâ€™

data/spam.txt       100%[===================&gt;]  10.34M   809KB/s    in 17s     

2024-06-20 10:56:18 (615 KB/s) - â€˜data/spam.txtâ€™ saved [10843548/10843548]
</code></pre>
</div>
</div>
<div id="5319f1b6" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Utility functions for the neural network</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Tensor (<span class="bu">object</span>):</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,data,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>                 autograd<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>                 creators<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>                 creation_op<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>                 <span class="bu">id</span><span class="op">=</span><span class="va">None</span>):</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data <span class="op">=</span> np.array(data)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.autograd <span class="op">=</span> autograd</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.grad <span class="op">=</span> <span class="va">None</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="bu">id</span> <span class="kw">is</span> <span class="va">None</span>):</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.<span class="bu">id</span> <span class="op">=</span> np.random.randint(<span class="dv">0</span>,<span class="dv">1000000000</span>)</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.<span class="bu">id</span> <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.creators <span class="op">=</span> creators</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.creation_op <span class="op">=</span> creation_op</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.children <span class="op">=</span> {}</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(creators <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>):</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> c <span class="kw">in</span> creators:</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="va">self</span>.<span class="bu">id</span> <span class="kw">not</span> <span class="kw">in</span> c.children):</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>                    c.children[<span class="va">self</span>.<span class="bu">id</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>                    c.children[<span class="va">self</span>.<span class="bu">id</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> all_children_grads_accounted_for(<span class="va">self</span>):</span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="bu">id</span>,cnt <span class="kw">in</span> <span class="va">self</span>.children.items():</span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(cnt <span class="op">!=</span> <span class="dv">0</span>):</span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span> </span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> backward(<span class="va">self</span>,grad<span class="op">=</span><span class="va">None</span>, grad_origin<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd):</span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(grad <span class="kw">is</span> <span class="va">None</span>):</span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a>                grad <span class="op">=</span> Tensor(np.ones_like(<span class="va">self</span>.data))</span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(grad_origin <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>):</span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="va">self</span>.children[grad_origin.<span class="bu">id</span>] <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span></span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="va">self</span>.<span class="bu">id</span>)</span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="va">self</span>.creation_op)</span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="bu">len</span>(<span class="va">self</span>.creators))</span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> c <span class="kw">in</span> <span class="va">self</span>.creators:</span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(c.creation_op)</span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"cannot backprop more than once"</span>)</span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.children[grad_origin.<span class="bu">id</span>] <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="va">self</span>.grad <span class="kw">is</span> <span class="va">None</span>):</span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.grad <span class="op">=</span> grad</span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.grad <span class="op">+=</span> grad</span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb65-60"><a href="#cb65-60" aria-hidden="true" tabindex="-1"></a>            <span class="co"># grads must not have grads of their own</span></span>
<span id="cb65-61"><a href="#cb65-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">assert</span> grad.autograd <span class="op">==</span> <span class="va">False</span></span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb65-63"><a href="#cb65-63" aria-hidden="true" tabindex="-1"></a>            <span class="co"># only continue backpropping if there's something to</span></span>
<span id="cb65-64"><a href="#cb65-64" aria-hidden="true" tabindex="-1"></a>            <span class="co"># backprop into and if all gradients (from children)</span></span>
<span id="cb65-65"><a href="#cb65-65" aria-hidden="true" tabindex="-1"></a>            <span class="co"># are accounted for override waiting for children if</span></span>
<span id="cb65-66"><a href="#cb65-66" aria-hidden="true" tabindex="-1"></a>            <span class="co"># "backprop" was called on this variable directly</span></span>
<span id="cb65-67"><a href="#cb65-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="va">self</span>.creators <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> </span>
<span id="cb65-68"><a href="#cb65-68" aria-hidden="true" tabindex="-1"></a>               (<span class="va">self</span>.all_children_grads_accounted_for() <span class="kw">or</span> </span>
<span id="cb65-69"><a href="#cb65-69" aria-hidden="true" tabindex="-1"></a>                grad_origin <span class="kw">is</span> <span class="va">None</span>)):</span>
<span id="cb65-70"><a href="#cb65-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-71"><a href="#cb65-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="va">self</span>.creation_op <span class="op">==</span> <span class="st">"add"</span>):</span>
<span id="cb65-72"><a href="#cb65-72" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">0</span>].backward(<span class="va">self</span>.grad, <span class="va">self</span>)</span>
<span id="cb65-73"><a href="#cb65-73" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">1</span>].backward(<span class="va">self</span>.grad, <span class="va">self</span>)</span>
<span id="cb65-74"><a href="#cb65-74" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb65-75"><a href="#cb65-75" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="va">self</span>.creation_op <span class="op">==</span> <span class="st">"sub"</span>):</span>
<span id="cb65-76"><a href="#cb65-76" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">0</span>].backward(Tensor(<span class="va">self</span>.grad.data), <span class="va">self</span>)</span>
<span id="cb65-77"><a href="#cb65-77" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">1</span>].backward(Tensor(<span class="va">self</span>.grad.<span class="fu">__neg__</span>().data), <span class="va">self</span>)</span>
<span id="cb65-78"><a href="#cb65-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-79"><a href="#cb65-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="va">self</span>.creation_op <span class="op">==</span> <span class="st">"mul"</span>):</span>
<span id="cb65-80"><a href="#cb65-80" aria-hidden="true" tabindex="-1"></a>                    new <span class="op">=</span> <span class="va">self</span>.grad <span class="op">*</span> <span class="va">self</span>.creators[<span class="dv">1</span>]</span>
<span id="cb65-81"><a href="#cb65-81" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">0</span>].backward(new , <span class="va">self</span>)</span>
<span id="cb65-82"><a href="#cb65-82" aria-hidden="true" tabindex="-1"></a>                    new <span class="op">=</span> <span class="va">self</span>.grad <span class="op">*</span> <span class="va">self</span>.creators[<span class="dv">0</span>]</span>
<span id="cb65-83"><a href="#cb65-83" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">1</span>].backward(new, <span class="va">self</span>)                    </span>
<span id="cb65-84"><a href="#cb65-84" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb65-85"><a href="#cb65-85" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="va">self</span>.creation_op <span class="op">==</span> <span class="st">"mm"</span>):</span>
<span id="cb65-86"><a href="#cb65-86" aria-hidden="true" tabindex="-1"></a>                    c0 <span class="op">=</span> <span class="va">self</span>.creators[<span class="dv">0</span>]</span>
<span id="cb65-87"><a href="#cb65-87" aria-hidden="true" tabindex="-1"></a>                    c1 <span class="op">=</span> <span class="va">self</span>.creators[<span class="dv">1</span>]</span>
<span id="cb65-88"><a href="#cb65-88" aria-hidden="true" tabindex="-1"></a>                    new <span class="op">=</span> <span class="va">self</span>.grad.mm(c1.transpose())</span>
<span id="cb65-89"><a href="#cb65-89" aria-hidden="true" tabindex="-1"></a>                    c0.backward(new)</span>
<span id="cb65-90"><a href="#cb65-90" aria-hidden="true" tabindex="-1"></a>                    new <span class="op">=</span> <span class="va">self</span>.grad.transpose().mm(c0).transpose()</span>
<span id="cb65-91"><a href="#cb65-91" aria-hidden="true" tabindex="-1"></a>                    c1.backward(new)</span>
<span id="cb65-92"><a href="#cb65-92" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb65-93"><a href="#cb65-93" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="va">self</span>.creation_op <span class="op">==</span> <span class="st">"transpose"</span>):</span>
<span id="cb65-94"><a href="#cb65-94" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">0</span>].backward(<span class="va">self</span>.grad.transpose())</span>
<span id="cb65-95"><a href="#cb65-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-96"><a href="#cb65-96" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="st">"sum"</span> <span class="kw">in</span> <span class="va">self</span>.creation_op):</span>
<span id="cb65-97"><a href="#cb65-97" aria-hidden="true" tabindex="-1"></a>                    dim <span class="op">=</span> <span class="bu">int</span>(<span class="va">self</span>.creation_op.split(<span class="st">"_"</span>)[<span class="dv">1</span>])</span>
<span id="cb65-98"><a href="#cb65-98" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">0</span>].backward(<span class="va">self</span>.grad.expand(dim,</span>
<span id="cb65-99"><a href="#cb65-99" aria-hidden="true" tabindex="-1"></a>                                                               <span class="va">self</span>.creators[<span class="dv">0</span>].data.shape[dim]))</span>
<span id="cb65-100"><a href="#cb65-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-101"><a href="#cb65-101" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="st">"expand"</span> <span class="kw">in</span> <span class="va">self</span>.creation_op):</span>
<span id="cb65-102"><a href="#cb65-102" aria-hidden="true" tabindex="-1"></a>                    dim <span class="op">=</span> <span class="bu">int</span>(<span class="va">self</span>.creation_op.split(<span class="st">"_"</span>)[<span class="dv">1</span>])</span>
<span id="cb65-103"><a href="#cb65-103" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">0</span>].backward(<span class="va">self</span>.grad.<span class="bu">sum</span>(dim))</span>
<span id="cb65-104"><a href="#cb65-104" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb65-105"><a href="#cb65-105" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="va">self</span>.creation_op <span class="op">==</span> <span class="st">"neg"</span>):</span>
<span id="cb65-106"><a href="#cb65-106" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">0</span>].backward(<span class="va">self</span>.grad.<span class="fu">__neg__</span>())</span>
<span id="cb65-107"><a href="#cb65-107" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb65-108"><a href="#cb65-108" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="va">self</span>.creation_op <span class="op">==</span> <span class="st">"sigmoid"</span>):</span>
<span id="cb65-109"><a href="#cb65-109" aria-hidden="true" tabindex="-1"></a>                    ones <span class="op">=</span> Tensor(np.ones_like(<span class="va">self</span>.grad.data))</span>
<span id="cb65-110"><a href="#cb65-110" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">0</span>].backward(<span class="va">self</span>.grad <span class="op">*</span> (<span class="va">self</span> <span class="op">*</span> (ones <span class="op">-</span> <span class="va">self</span>)))</span>
<span id="cb65-111"><a href="#cb65-111" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb65-112"><a href="#cb65-112" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="va">self</span>.creation_op <span class="op">==</span> <span class="st">"tanh"</span>):</span>
<span id="cb65-113"><a href="#cb65-113" aria-hidden="true" tabindex="-1"></a>                    ones <span class="op">=</span> Tensor(np.ones_like(<span class="va">self</span>.grad.data))</span>
<span id="cb65-114"><a href="#cb65-114" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">0</span>].backward(<span class="va">self</span>.grad <span class="op">*</span> (ones <span class="op">-</span> (<span class="va">self</span> <span class="op">*</span> <span class="va">self</span>)))</span>
<span id="cb65-115"><a href="#cb65-115" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb65-116"><a href="#cb65-116" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="va">self</span>.creation_op <span class="op">==</span> <span class="st">"index_select"</span>):</span>
<span id="cb65-117"><a href="#cb65-117" aria-hidden="true" tabindex="-1"></a>                    new_grad <span class="op">=</span> np.zeros_like(<span class="va">self</span>.creators[<span class="dv">0</span>].data)</span>
<span id="cb65-118"><a href="#cb65-118" aria-hidden="true" tabindex="-1"></a>                    indices_ <span class="op">=</span> <span class="va">self</span>.index_select_indices.data.flatten()</span>
<span id="cb65-119"><a href="#cb65-119" aria-hidden="true" tabindex="-1"></a>                    grad_ <span class="op">=</span> grad.data.reshape(<span class="bu">len</span>(indices_), <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb65-120"><a href="#cb65-120" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(indices_)):</span>
<span id="cb65-121"><a href="#cb65-121" aria-hidden="true" tabindex="-1"></a>                        new_grad[indices_[i]] <span class="op">+=</span> grad_[i]</span>
<span id="cb65-122"><a href="#cb65-122" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">0</span>].backward(Tensor(new_grad))</span>
<span id="cb65-123"><a href="#cb65-123" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb65-124"><a href="#cb65-124" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="va">self</span>.creation_op <span class="op">==</span> <span class="st">"cross_entropy"</span>):</span>
<span id="cb65-125"><a href="#cb65-125" aria-hidden="true" tabindex="-1"></a>                    dx <span class="op">=</span> <span class="va">self</span>.softmax_output <span class="op">-</span> <span class="va">self</span>.target_dist</span>
<span id="cb65-126"><a href="#cb65-126" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.creators[<span class="dv">0</span>].backward(Tensor(dx))</span>
<span id="cb65-127"><a href="#cb65-127" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb65-128"><a href="#cb65-128" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__add__</span>(<span class="va">self</span>, other):</span>
<span id="cb65-129"><a href="#cb65-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd <span class="kw">and</span> other.autograd):</span>
<span id="cb65-130"><a href="#cb65-130" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Tensor(<span class="va">self</span>.data <span class="op">+</span> other.data,</span>
<span id="cb65-131"><a href="#cb65-131" aria-hidden="true" tabindex="-1"></a>                          autograd<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb65-132"><a href="#cb65-132" aria-hidden="true" tabindex="-1"></a>                          creators<span class="op">=</span>[<span class="va">self</span>,other],</span>
<span id="cb65-133"><a href="#cb65-133" aria-hidden="true" tabindex="-1"></a>                          creation_op<span class="op">=</span><span class="st">"add"</span>)</span>
<span id="cb65-134"><a href="#cb65-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(<span class="va">self</span>.data <span class="op">+</span> other.data)</span>
<span id="cb65-135"><a href="#cb65-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-136"><a href="#cb65-136" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__neg__</span>(<span class="va">self</span>):</span>
<span id="cb65-137"><a href="#cb65-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd):</span>
<span id="cb65-138"><a href="#cb65-138" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Tensor(<span class="va">self</span>.data <span class="op">*</span> <span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb65-139"><a href="#cb65-139" aria-hidden="true" tabindex="-1"></a>                          autograd<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb65-140"><a href="#cb65-140" aria-hidden="true" tabindex="-1"></a>                          creators<span class="op">=</span>[<span class="va">self</span>],</span>
<span id="cb65-141"><a href="#cb65-141" aria-hidden="true" tabindex="-1"></a>                          creation_op<span class="op">=</span><span class="st">"neg"</span>)</span>
<span id="cb65-142"><a href="#cb65-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(<span class="va">self</span>.data <span class="op">*</span> <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb65-143"><a href="#cb65-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-144"><a href="#cb65-144" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__sub__</span>(<span class="va">self</span>, other):</span>
<span id="cb65-145"><a href="#cb65-145" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd <span class="kw">and</span> other.autograd):</span>
<span id="cb65-146"><a href="#cb65-146" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Tensor(<span class="va">self</span>.data <span class="op">-</span> other.data,</span>
<span id="cb65-147"><a href="#cb65-147" aria-hidden="true" tabindex="-1"></a>                          autograd<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb65-148"><a href="#cb65-148" aria-hidden="true" tabindex="-1"></a>                          creators<span class="op">=</span>[<span class="va">self</span>,other],</span>
<span id="cb65-149"><a href="#cb65-149" aria-hidden="true" tabindex="-1"></a>                          creation_op<span class="op">=</span><span class="st">"sub"</span>)</span>
<span id="cb65-150"><a href="#cb65-150" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(<span class="va">self</span>.data <span class="op">-</span> other.data)</span>
<span id="cb65-151"><a href="#cb65-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-152"><a href="#cb65-152" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__mul__</span>(<span class="va">self</span>, other):</span>
<span id="cb65-153"><a href="#cb65-153" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd <span class="kw">and</span> other.autograd):</span>
<span id="cb65-154"><a href="#cb65-154" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Tensor(<span class="va">self</span>.data <span class="op">*</span> other.data,</span>
<span id="cb65-155"><a href="#cb65-155" aria-hidden="true" tabindex="-1"></a>                          autograd<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb65-156"><a href="#cb65-156" aria-hidden="true" tabindex="-1"></a>                          creators<span class="op">=</span>[<span class="va">self</span>,other],</span>
<span id="cb65-157"><a href="#cb65-157" aria-hidden="true" tabindex="-1"></a>                          creation_op<span class="op">=</span><span class="st">"mul"</span>)</span>
<span id="cb65-158"><a href="#cb65-158" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(<span class="va">self</span>.data <span class="op">*</span> other.data)    </span>
<span id="cb65-159"><a href="#cb65-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-160"><a href="#cb65-160" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="bu">sum</span>(<span class="va">self</span>, dim):</span>
<span id="cb65-161"><a href="#cb65-161" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd):</span>
<span id="cb65-162"><a href="#cb65-162" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Tensor(<span class="va">self</span>.data.<span class="bu">sum</span>(dim),</span>
<span id="cb65-163"><a href="#cb65-163" aria-hidden="true" tabindex="-1"></a>                          autograd<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb65-164"><a href="#cb65-164" aria-hidden="true" tabindex="-1"></a>                          creators<span class="op">=</span>[<span class="va">self</span>],</span>
<span id="cb65-165"><a href="#cb65-165" aria-hidden="true" tabindex="-1"></a>                          creation_op<span class="op">=</span><span class="st">"sum_"</span><span class="op">+</span><span class="bu">str</span>(dim))</span>
<span id="cb65-166"><a href="#cb65-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(<span class="va">self</span>.data.<span class="bu">sum</span>(dim))</span>
<span id="cb65-167"><a href="#cb65-167" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-168"><a href="#cb65-168" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> expand(<span class="va">self</span>, dim,copies):</span>
<span id="cb65-169"><a href="#cb65-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-170"><a href="#cb65-170" aria-hidden="true" tabindex="-1"></a>        trans_cmd <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">0</span>,<span class="bu">len</span>(<span class="va">self</span>.data.shape)))</span>
<span id="cb65-171"><a href="#cb65-171" aria-hidden="true" tabindex="-1"></a>        trans_cmd.insert(dim,<span class="bu">len</span>(<span class="va">self</span>.data.shape))</span>
<span id="cb65-172"><a href="#cb65-172" aria-hidden="true" tabindex="-1"></a>        new_data <span class="op">=</span> <span class="va">self</span>.data.repeat(copies).reshape(<span class="bu">list</span>(<span class="va">self</span>.data.shape) <span class="op">+</span> [copies]).transpose(trans_cmd)</span>
<span id="cb65-173"><a href="#cb65-173" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-174"><a href="#cb65-174" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd):</span>
<span id="cb65-175"><a href="#cb65-175" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Tensor(new_data,</span>
<span id="cb65-176"><a href="#cb65-176" aria-hidden="true" tabindex="-1"></a>                          autograd<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb65-177"><a href="#cb65-177" aria-hidden="true" tabindex="-1"></a>                          creators<span class="op">=</span>[<span class="va">self</span>],</span>
<span id="cb65-178"><a href="#cb65-178" aria-hidden="true" tabindex="-1"></a>                          creation_op<span class="op">=</span><span class="st">"expand_"</span><span class="op">+</span><span class="bu">str</span>(dim))</span>
<span id="cb65-179"><a href="#cb65-179" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(new_data)</span>
<span id="cb65-180"><a href="#cb65-180" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-181"><a href="#cb65-181" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transpose(<span class="va">self</span>):</span>
<span id="cb65-182"><a href="#cb65-182" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd):</span>
<span id="cb65-183"><a href="#cb65-183" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Tensor(<span class="va">self</span>.data.transpose(),</span>
<span id="cb65-184"><a href="#cb65-184" aria-hidden="true" tabindex="-1"></a>                          autograd<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb65-185"><a href="#cb65-185" aria-hidden="true" tabindex="-1"></a>                          creators<span class="op">=</span>[<span class="va">self</span>],</span>
<span id="cb65-186"><a href="#cb65-186" aria-hidden="true" tabindex="-1"></a>                          creation_op<span class="op">=</span><span class="st">"transpose"</span>)</span>
<span id="cb65-187"><a href="#cb65-187" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-188"><a href="#cb65-188" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(<span class="va">self</span>.data.transpose())</span>
<span id="cb65-189"><a href="#cb65-189" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-190"><a href="#cb65-190" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mm(<span class="va">self</span>, x):</span>
<span id="cb65-191"><a href="#cb65-191" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd):</span>
<span id="cb65-192"><a href="#cb65-192" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Tensor(<span class="va">self</span>.data.dot(x.data),</span>
<span id="cb65-193"><a href="#cb65-193" aria-hidden="true" tabindex="-1"></a>                          autograd<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb65-194"><a href="#cb65-194" aria-hidden="true" tabindex="-1"></a>                          creators<span class="op">=</span>[<span class="va">self</span>,x],</span>
<span id="cb65-195"><a href="#cb65-195" aria-hidden="true" tabindex="-1"></a>                          creation_op<span class="op">=</span><span class="st">"mm"</span>)</span>
<span id="cb65-196"><a href="#cb65-196" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(<span class="va">self</span>.data.dot(x.data))</span>
<span id="cb65-197"><a href="#cb65-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-198"><a href="#cb65-198" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sigmoid(<span class="va">self</span>):</span>
<span id="cb65-199"><a href="#cb65-199" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd):</span>
<span id="cb65-200"><a href="#cb65-200" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Tensor(<span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> np.exp(<span class="op">-</span><span class="va">self</span>.data)),</span>
<span id="cb65-201"><a href="#cb65-201" aria-hidden="true" tabindex="-1"></a>                          autograd<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb65-202"><a href="#cb65-202" aria-hidden="true" tabindex="-1"></a>                          creators<span class="op">=</span>[<span class="va">self</span>],</span>
<span id="cb65-203"><a href="#cb65-203" aria-hidden="true" tabindex="-1"></a>                          creation_op<span class="op">=</span><span class="st">"sigmoid"</span>)</span>
<span id="cb65-204"><a href="#cb65-204" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(<span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> np.exp(<span class="op">-</span><span class="va">self</span>.data)))</span>
<span id="cb65-205"><a href="#cb65-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-206"><a href="#cb65-206" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tanh(<span class="va">self</span>):</span>
<span id="cb65-207"><a href="#cb65-207" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd):</span>
<span id="cb65-208"><a href="#cb65-208" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Tensor(np.tanh(<span class="va">self</span>.data),</span>
<span id="cb65-209"><a href="#cb65-209" aria-hidden="true" tabindex="-1"></a>                          autograd<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb65-210"><a href="#cb65-210" aria-hidden="true" tabindex="-1"></a>                          creators<span class="op">=</span>[<span class="va">self</span>],</span>
<span id="cb65-211"><a href="#cb65-211" aria-hidden="true" tabindex="-1"></a>                          creation_op<span class="op">=</span><span class="st">"tanh"</span>)</span>
<span id="cb65-212"><a href="#cb65-212" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(np.tanh(<span class="va">self</span>.data))</span>
<span id="cb65-213"><a href="#cb65-213" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-214"><a href="#cb65-214" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> index_select(<span class="va">self</span>, indices):</span>
<span id="cb65-215"><a href="#cb65-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-216"><a href="#cb65-216" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd):</span>
<span id="cb65-217"><a href="#cb65-217" aria-hidden="true" tabindex="-1"></a>            new <span class="op">=</span> Tensor(<span class="va">self</span>.data[indices.data],</span>
<span id="cb65-218"><a href="#cb65-218" aria-hidden="true" tabindex="-1"></a>                         autograd<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb65-219"><a href="#cb65-219" aria-hidden="true" tabindex="-1"></a>                         creators<span class="op">=</span>[<span class="va">self</span>],</span>
<span id="cb65-220"><a href="#cb65-220" aria-hidden="true" tabindex="-1"></a>                         creation_op<span class="op">=</span><span class="st">"index_select"</span>)</span>
<span id="cb65-221"><a href="#cb65-221" aria-hidden="true" tabindex="-1"></a>            new.index_select_indices <span class="op">=</span> indices</span>
<span id="cb65-222"><a href="#cb65-222" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> new</span>
<span id="cb65-223"><a href="#cb65-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(<span class="va">self</span>.data[indices.data])</span>
<span id="cb65-224"><a href="#cb65-224" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-225"><a href="#cb65-225" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> softmax(<span class="va">self</span>):</span>
<span id="cb65-226"><a href="#cb65-226" aria-hidden="true" tabindex="-1"></a>        temp <span class="op">=</span> np.exp(<span class="va">self</span>.data)</span>
<span id="cb65-227"><a href="#cb65-227" aria-hidden="true" tabindex="-1"></a>        softmax_output <span class="op">=</span> temp <span class="op">/</span> np.<span class="bu">sum</span>(temp,</span>
<span id="cb65-228"><a href="#cb65-228" aria-hidden="true" tabindex="-1"></a>                                       axis<span class="op">=</span><span class="bu">len</span>(<span class="va">self</span>.data.shape)<span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb65-229"><a href="#cb65-229" aria-hidden="true" tabindex="-1"></a>                                       keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-230"><a href="#cb65-230" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> softmax_output</span>
<span id="cb65-231"><a href="#cb65-231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-232"><a href="#cb65-232" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> cross_entropy(<span class="va">self</span>, target_indices):</span>
<span id="cb65-233"><a href="#cb65-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-234"><a href="#cb65-234" aria-hidden="true" tabindex="-1"></a>        temp <span class="op">=</span> np.exp(<span class="va">self</span>.data)</span>
<span id="cb65-235"><a href="#cb65-235" aria-hidden="true" tabindex="-1"></a>        softmax_output <span class="op">=</span> temp <span class="op">/</span> np.<span class="bu">sum</span>(temp,</span>
<span id="cb65-236"><a href="#cb65-236" aria-hidden="true" tabindex="-1"></a>                                       axis<span class="op">=</span><span class="bu">len</span>(<span class="va">self</span>.data.shape)<span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb65-237"><a href="#cb65-237" aria-hidden="true" tabindex="-1"></a>                                       keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-238"><a href="#cb65-238" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-239"><a href="#cb65-239" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> target_indices.data.flatten()</span>
<span id="cb65-240"><a href="#cb65-240" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> softmax_output.reshape(<span class="bu">len</span>(t),<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb65-241"><a href="#cb65-241" aria-hidden="true" tabindex="-1"></a>        target_dist <span class="op">=</span> np.eye(p.shape[<span class="dv">1</span>])[t]</span>
<span id="cb65-242"><a href="#cb65-242" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> <span class="op">-</span>(np.log(p) <span class="op">*</span> (target_dist)).<span class="bu">sum</span>(<span class="dv">1</span>).mean()</span>
<span id="cb65-243"><a href="#cb65-243" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-244"><a href="#cb65-244" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.autograd):</span>
<span id="cb65-245"><a href="#cb65-245" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> Tensor(loss,</span>
<span id="cb65-246"><a href="#cb65-246" aria-hidden="true" tabindex="-1"></a>                         autograd<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb65-247"><a href="#cb65-247" aria-hidden="true" tabindex="-1"></a>                         creators<span class="op">=</span>[<span class="va">self</span>],</span>
<span id="cb65-248"><a href="#cb65-248" aria-hidden="true" tabindex="-1"></a>                         creation_op<span class="op">=</span><span class="st">"cross_entropy"</span>)</span>
<span id="cb65-249"><a href="#cb65-249" aria-hidden="true" tabindex="-1"></a>            out.softmax_output <span class="op">=</span> softmax_output</span>
<span id="cb65-250"><a href="#cb65-250" aria-hidden="true" tabindex="-1"></a>            out.target_dist <span class="op">=</span> target_dist</span>
<span id="cb65-251"><a href="#cb65-251" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> out</span>
<span id="cb65-252"><a href="#cb65-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-253"><a href="#cb65-253" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(loss)</span>
<span id="cb65-254"><a href="#cb65-254" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-255"><a href="#cb65-255" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-256"><a href="#cb65-256" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</span>
<span id="cb65-257"><a href="#cb65-257" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">str</span>(<span class="va">self</span>.data.<span class="fu">__repr__</span>())</span>
<span id="cb65-258"><a href="#cb65-258" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-259"><a href="#cb65-259" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb65-260"><a href="#cb65-260" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">str</span>(<span class="va">self</span>.data.<span class="fu">__str__</span>())  </span>
<span id="cb65-261"><a href="#cb65-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-262"><a href="#cb65-262" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Layer(<span class="bu">object</span>):</span>
<span id="cb65-263"><a href="#cb65-263" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-264"><a href="#cb65-264" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb65-265"><a href="#cb65-265" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb65-266"><a href="#cb65-266" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-267"><a href="#cb65-267" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_parameters(<span class="va">self</span>):</span>
<span id="cb65-268"><a href="#cb65-268" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.parameters</span>
<span id="cb65-269"><a href="#cb65-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-270"><a href="#cb65-270" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-271"><a href="#cb65-271" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SGD(<span class="bu">object</span>):</span>
<span id="cb65-272"><a href="#cb65-272" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-273"><a href="#cb65-273" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, parameters, alpha<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb65-274"><a href="#cb65-274" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">=</span> parameters</span>
<span id="cb65-275"><a href="#cb65-275" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.alpha <span class="op">=</span> alpha</span>
<span id="cb65-276"><a href="#cb65-276" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-277"><a href="#cb65-277" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> zero(<span class="va">self</span>):</span>
<span id="cb65-278"><a href="#cb65-278" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.parameters:</span>
<span id="cb65-279"><a href="#cb65-279" aria-hidden="true" tabindex="-1"></a>            p.grad.data <span class="op">*=</span> <span class="dv">0</span></span>
<span id="cb65-280"><a href="#cb65-280" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-281"><a href="#cb65-281" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> step(<span class="va">self</span>, zero<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb65-282"><a href="#cb65-282" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-283"><a href="#cb65-283" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.parameters:</span>
<span id="cb65-284"><a href="#cb65-284" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb65-285"><a href="#cb65-285" aria-hidden="true" tabindex="-1"></a>            p.data <span class="op">-=</span> p.grad.data <span class="op">*</span> <span class="va">self</span>.alpha</span>
<span id="cb65-286"><a href="#cb65-286" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb65-287"><a href="#cb65-287" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(zero):</span>
<span id="cb65-288"><a href="#cb65-288" aria-hidden="true" tabindex="-1"></a>                p.grad.data <span class="op">*=</span> <span class="dv">0</span></span>
<span id="cb65-289"><a href="#cb65-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-290"><a href="#cb65-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-291"><a href="#cb65-291" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Linear(Layer):</span>
<span id="cb65-292"><a href="#cb65-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-293"><a href="#cb65-293" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_inputs, n_outputs, bias<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb65-294"><a href="#cb65-294" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb65-295"><a href="#cb65-295" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-296"><a href="#cb65-296" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_bias <span class="op">=</span> bias</span>
<span id="cb65-297"><a href="#cb65-297" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-298"><a href="#cb65-298" aria-hidden="true" tabindex="-1"></a>        W <span class="op">=</span> np.random.randn(n_inputs, n_outputs) <span class="op">*</span> np.sqrt(<span class="fl">2.0</span><span class="op">/</span>(n_inputs))</span>
<span id="cb65-299"><a href="#cb65-299" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.weight <span class="op">=</span> Tensor(W, autograd<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-300"><a href="#cb65-300" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.use_bias):</span>
<span id="cb65-301"><a href="#cb65-301" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.bias <span class="op">=</span> Tensor(np.zeros(n_outputs), autograd<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-302"><a href="#cb65-302" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-303"><a href="#cb65-303" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters.append(<span class="va">self</span>.weight)</span>
<span id="cb65-304"><a href="#cb65-304" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-305"><a href="#cb65-305" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.use_bias):        </span>
<span id="cb65-306"><a href="#cb65-306" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.parameters.append(<span class="va">self</span>.bias)</span>
<span id="cb65-307"><a href="#cb65-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-308"><a href="#cb65-308" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="bu">input</span>):</span>
<span id="cb65-309"><a href="#cb65-309" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">self</span>.use_bias):</span>
<span id="cb65-310"><a href="#cb65-310" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">input</span>.mm(<span class="va">self</span>.weight)<span class="op">+</span><span class="va">self</span>.bias.expand(<span class="dv">0</span>,<span class="bu">len</span>(<span class="bu">input</span>.data))</span>
<span id="cb65-311"><a href="#cb65-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">input</span>.mm(<span class="va">self</span>.weight)</span>
<span id="cb65-312"><a href="#cb65-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-313"><a href="#cb65-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-314"><a href="#cb65-314" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Sequential(Layer):</span>
<span id="cb65-315"><a href="#cb65-315" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-316"><a href="#cb65-316" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, layers<span class="op">=</span><span class="bu">list</span>()):</span>
<span id="cb65-317"><a href="#cb65-317" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb65-318"><a href="#cb65-318" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-319"><a href="#cb65-319" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.layers <span class="op">=</span> layers</span>
<span id="cb65-320"><a href="#cb65-320" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-321"><a href="#cb65-321" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add(<span class="va">self</span>, layer):</span>
<span id="cb65-322"><a href="#cb65-322" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.layers.append(layer)</span>
<span id="cb65-323"><a href="#cb65-323" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-324"><a href="#cb65-324" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="bu">input</span>):</span>
<span id="cb65-325"><a href="#cb65-325" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> layer <span class="kw">in</span> <span class="va">self</span>.layers:</span>
<span id="cb65-326"><a href="#cb65-326" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span> <span class="op">=</span> layer.forward(<span class="bu">input</span>)</span>
<span id="cb65-327"><a href="#cb65-327" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">input</span></span>
<span id="cb65-328"><a href="#cb65-328" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-329"><a href="#cb65-329" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_parameters(<span class="va">self</span>):</span>
<span id="cb65-330"><a href="#cb65-330" aria-hidden="true" tabindex="-1"></a>        params <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb65-331"><a href="#cb65-331" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> l <span class="kw">in</span> <span class="va">self</span>.layers:</span>
<span id="cb65-332"><a href="#cb65-332" aria-hidden="true" tabindex="-1"></a>            params <span class="op">+=</span> l.get_parameters()</span>
<span id="cb65-333"><a href="#cb65-333" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> params</span>
<span id="cb65-334"><a href="#cb65-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-335"><a href="#cb65-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-336"><a href="#cb65-336" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Embedding(Layer):</span>
<span id="cb65-337"><a href="#cb65-337" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-338"><a href="#cb65-338" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, vocab_size, dim):</span>
<span id="cb65-339"><a href="#cb65-339" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb65-340"><a href="#cb65-340" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-341"><a href="#cb65-341" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vocab_size <span class="op">=</span> vocab_size</span>
<span id="cb65-342"><a href="#cb65-342" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dim <span class="op">=</span> dim</span>
<span id="cb65-343"><a href="#cb65-343" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-344"><a href="#cb65-344" aria-hidden="true" tabindex="-1"></a>        <span class="co"># this random initialiation style is just a convention from word2vec</span></span>
<span id="cb65-345"><a href="#cb65-345" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.weight <span class="op">=</span> Tensor((np.random.rand(vocab_size, dim) <span class="op">-</span> <span class="fl">0.5</span>) <span class="op">/</span> dim, autograd<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-346"><a href="#cb65-346" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-347"><a href="#cb65-347" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters.append(<span class="va">self</span>.weight)</span>
<span id="cb65-348"><a href="#cb65-348" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-349"><a href="#cb65-349" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="bu">input</span>):</span>
<span id="cb65-350"><a href="#cb65-350" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.weight.index_select(<span class="bu">input</span>)</span>
<span id="cb65-351"><a href="#cb65-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-352"><a href="#cb65-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-353"><a href="#cb65-353" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Tanh(Layer):</span>
<span id="cb65-354"><a href="#cb65-354" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb65-355"><a href="#cb65-355" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb65-356"><a href="#cb65-356" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-357"><a href="#cb65-357" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="bu">input</span>):</span>
<span id="cb65-358"><a href="#cb65-358" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">input</span>.tanh()</span>
<span id="cb65-359"><a href="#cb65-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-360"><a href="#cb65-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-361"><a href="#cb65-361" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Sigmoid(Layer):</span>
<span id="cb65-362"><a href="#cb65-362" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb65-363"><a href="#cb65-363" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb65-364"><a href="#cb65-364" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-365"><a href="#cb65-365" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="bu">input</span>):</span>
<span id="cb65-366"><a href="#cb65-366" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">input</span>.sigmoid()</span>
<span id="cb65-367"><a href="#cb65-367" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-368"><a href="#cb65-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-369"><a href="#cb65-369" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CrossEntropyLoss(<span class="bu">object</span>):</span>
<span id="cb65-370"><a href="#cb65-370" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-371"><a href="#cb65-371" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb65-372"><a href="#cb65-372" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb65-373"><a href="#cb65-373" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-374"><a href="#cb65-374" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="bu">input</span>, target):</span>
<span id="cb65-375"><a href="#cb65-375" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">input</span>.cross_entropy(target)</span>
<span id="cb65-376"><a href="#cb65-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-377"><a href="#cb65-377" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MSELoss(<span class="bu">object</span>):</span>
<span id="cb65-378"><a href="#cb65-378" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-379"><a href="#cb65-379" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb65-380"><a href="#cb65-380" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb65-381"><a href="#cb65-381" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-382"><a href="#cb65-382" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="bu">input</span>, target):</span>
<span id="cb65-383"><a href="#cb65-383" aria-hidden="true" tabindex="-1"></a>        dif <span class="op">=</span> <span class="bu">input</span> <span class="op">-</span> target</span>
<span id="cb65-384"><a href="#cb65-384" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (dif <span class="op">*</span> dif).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb65-385"><a href="#cb65-385" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-386"><a href="#cb65-386" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RNNCell(Layer):</span>
<span id="cb65-387"><a href="#cb65-387" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-388"><a href="#cb65-388" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_inputs, n_hidden, n_output, activation<span class="op">=</span><span class="st">'sigmoid'</span>):</span>
<span id="cb65-389"><a href="#cb65-389" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb65-390"><a href="#cb65-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-391"><a href="#cb65-391" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_inputs <span class="op">=</span> n_inputs</span>
<span id="cb65-392"><a href="#cb65-392" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_hidden <span class="op">=</span> n_hidden</span>
<span id="cb65-393"><a href="#cb65-393" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_output <span class="op">=</span> n_output</span>
<span id="cb65-394"><a href="#cb65-394" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-395"><a href="#cb65-395" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(activation <span class="op">==</span> <span class="st">'sigmoid'</span>):</span>
<span id="cb65-396"><a href="#cb65-396" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.activation <span class="op">=</span> Sigmoid()</span>
<span id="cb65-397"><a href="#cb65-397" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span>(activation <span class="op">==</span> <span class="st">'tanh'</span>):</span>
<span id="cb65-398"><a href="#cb65-398" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.activation <span class="op">==</span> Tanh()</span>
<span id="cb65-399"><a href="#cb65-399" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb65-400"><a href="#cb65-400" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"Non-linearity not found"</span>)</span>
<span id="cb65-401"><a href="#cb65-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-402"><a href="#cb65-402" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.w_ih <span class="op">=</span> Linear(n_inputs, n_hidden)</span>
<span id="cb65-403"><a href="#cb65-403" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.w_hh <span class="op">=</span> Linear(n_hidden, n_hidden)</span>
<span id="cb65-404"><a href="#cb65-404" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.w_ho <span class="op">=</span> Linear(n_hidden, n_output)</span>
<span id="cb65-405"><a href="#cb65-405" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-406"><a href="#cb65-406" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">+=</span> <span class="va">self</span>.w_ih.get_parameters()</span>
<span id="cb65-407"><a href="#cb65-407" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">+=</span> <span class="va">self</span>.w_hh.get_parameters()</span>
<span id="cb65-408"><a href="#cb65-408" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">+=</span> <span class="va">self</span>.w_ho.get_parameters()        </span>
<span id="cb65-409"><a href="#cb65-409" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-410"><a href="#cb65-410" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="bu">input</span>, hidden):</span>
<span id="cb65-411"><a href="#cb65-411" aria-hidden="true" tabindex="-1"></a>        from_prev_hidden <span class="op">=</span> <span class="va">self</span>.w_hh.forward(hidden)</span>
<span id="cb65-412"><a href="#cb65-412" aria-hidden="true" tabindex="-1"></a>        combined <span class="op">=</span> <span class="va">self</span>.w_ih.forward(<span class="bu">input</span>) <span class="op">+</span> from_prev_hidden</span>
<span id="cb65-413"><a href="#cb65-413" aria-hidden="true" tabindex="-1"></a>        new_hidden <span class="op">=</span> <span class="va">self</span>.activation.forward(combined)</span>
<span id="cb65-414"><a href="#cb65-414" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.w_ho.forward(new_hidden)</span>
<span id="cb65-415"><a href="#cb65-415" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output, new_hidden</span>
<span id="cb65-416"><a href="#cb65-416" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-417"><a href="#cb65-417" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> init_hidden(<span class="va">self</span>, batch_size<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb65-418"><a href="#cb65-418" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Tensor(np.zeros((batch_size,<span class="va">self</span>.n_hidden)), autograd<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-419"><a href="#cb65-419" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-420"><a href="#cb65-420" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LSTMCell(Layer):</span>
<span id="cb65-421"><a href="#cb65-421" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-422"><a href="#cb65-422" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_inputs, n_hidden, n_output):</span>
<span id="cb65-423"><a href="#cb65-423" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb65-424"><a href="#cb65-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-425"><a href="#cb65-425" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_inputs <span class="op">=</span> n_inputs</span>
<span id="cb65-426"><a href="#cb65-426" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_hidden <span class="op">=</span> n_hidden</span>
<span id="cb65-427"><a href="#cb65-427" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_output <span class="op">=</span> n_output</span>
<span id="cb65-428"><a href="#cb65-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-429"><a href="#cb65-429" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.xf <span class="op">=</span> Linear(n_inputs, n_hidden)</span>
<span id="cb65-430"><a href="#cb65-430" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.xi <span class="op">=</span> Linear(n_inputs, n_hidden)</span>
<span id="cb65-431"><a href="#cb65-431" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.xo <span class="op">=</span> Linear(n_inputs, n_hidden)        </span>
<span id="cb65-432"><a href="#cb65-432" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.xc <span class="op">=</span> Linear(n_inputs, n_hidden)        </span>
<span id="cb65-433"><a href="#cb65-433" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-434"><a href="#cb65-434" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hf <span class="op">=</span> Linear(n_hidden, n_hidden, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb65-435"><a href="#cb65-435" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hi <span class="op">=</span> Linear(n_hidden, n_hidden, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb65-436"><a href="#cb65-436" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ho <span class="op">=</span> Linear(n_hidden, n_hidden, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb65-437"><a href="#cb65-437" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hc <span class="op">=</span> Linear(n_hidden, n_hidden, bias<span class="op">=</span><span class="va">False</span>)        </span>
<span id="cb65-438"><a href="#cb65-438" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-439"><a href="#cb65-439" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.w_ho <span class="op">=</span> Linear(n_hidden, n_output, bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb65-440"><a href="#cb65-440" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-441"><a href="#cb65-441" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">+=</span> <span class="va">self</span>.xf.get_parameters()</span>
<span id="cb65-442"><a href="#cb65-442" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">+=</span> <span class="va">self</span>.xi.get_parameters()</span>
<span id="cb65-443"><a href="#cb65-443" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">+=</span> <span class="va">self</span>.xo.get_parameters()</span>
<span id="cb65-444"><a href="#cb65-444" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">+=</span> <span class="va">self</span>.xc.get_parameters()</span>
<span id="cb65-445"><a href="#cb65-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-446"><a href="#cb65-446" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">+=</span> <span class="va">self</span>.hf.get_parameters()</span>
<span id="cb65-447"><a href="#cb65-447" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">+=</span> <span class="va">self</span>.hi.get_parameters()        </span>
<span id="cb65-448"><a href="#cb65-448" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">+=</span> <span class="va">self</span>.ho.get_parameters()        </span>
<span id="cb65-449"><a href="#cb65-449" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">+=</span> <span class="va">self</span>.hc.get_parameters()                </span>
<span id="cb65-450"><a href="#cb65-450" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-451"><a href="#cb65-451" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">+=</span> <span class="va">self</span>.w_ho.get_parameters()        </span>
<span id="cb65-452"><a href="#cb65-452" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-453"><a href="#cb65-453" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="bu">input</span>, hidden):</span>
<span id="cb65-454"><a href="#cb65-454" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-455"><a href="#cb65-455" aria-hidden="true" tabindex="-1"></a>        prev_hidden <span class="op">=</span> hidden[<span class="dv">0</span>]        </span>
<span id="cb65-456"><a href="#cb65-456" aria-hidden="true" tabindex="-1"></a>        prev_cell <span class="op">=</span> hidden[<span class="dv">1</span>]</span>
<span id="cb65-457"><a href="#cb65-457" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-458"><a href="#cb65-458" aria-hidden="true" tabindex="-1"></a>        f <span class="op">=</span> (<span class="va">self</span>.xf.forward(<span class="bu">input</span>) <span class="op">+</span> <span class="va">self</span>.hf.forward(prev_hidden)).sigmoid()</span>
<span id="cb65-459"><a href="#cb65-459" aria-hidden="true" tabindex="-1"></a>        i <span class="op">=</span> (<span class="va">self</span>.xi.forward(<span class="bu">input</span>) <span class="op">+</span> <span class="va">self</span>.hi.forward(prev_hidden)).sigmoid()</span>
<span id="cb65-460"><a href="#cb65-460" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> (<span class="va">self</span>.xo.forward(<span class="bu">input</span>) <span class="op">+</span> <span class="va">self</span>.ho.forward(prev_hidden)).sigmoid()        </span>
<span id="cb65-461"><a href="#cb65-461" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> (<span class="va">self</span>.xc.forward(<span class="bu">input</span>) <span class="op">+</span> <span class="va">self</span>.hc.forward(prev_hidden)).tanh()        </span>
<span id="cb65-462"><a href="#cb65-462" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> (f <span class="op">*</span> prev_cell) <span class="op">+</span> (i <span class="op">*</span> g)</span>
<span id="cb65-463"><a href="#cb65-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-464"><a href="#cb65-464" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> o <span class="op">*</span> c.tanh()</span>
<span id="cb65-465"><a href="#cb65-465" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-466"><a href="#cb65-466" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.w_ho.forward(h)</span>
<span id="cb65-467"><a href="#cb65-467" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output, (h, c)</span>
<span id="cb65-468"><a href="#cb65-468" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-469"><a href="#cb65-469" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> init_hidden(<span class="va">self</span>, batch_size<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb65-470"><a href="#cb65-470" aria-hidden="true" tabindex="-1"></a>        init_hidden <span class="op">=</span> Tensor(np.zeros((batch_size,<span class="va">self</span>.n_hidden)), autograd<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-471"><a href="#cb65-471" aria-hidden="true" tabindex="-1"></a>        init_cell <span class="op">=</span> Tensor(np.zeros((batch_size,<span class="va">self</span>.n_hidden)), autograd<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-472"><a href="#cb65-472" aria-hidden="true" tabindex="-1"></a>        init_hidden.data[:,<span class="dv">0</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb65-473"><a href="#cb65-473" aria-hidden="true" tabindex="-1"></a>        init_cell.data[:,<span class="dv">0</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb65-474"><a href="#cb65-474" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (init_hidden, init_cell)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ca182ea9" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># preparation of the data</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co"># From the book Grokking Deep Learning by Andrew W. Trask, Manning Publications</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> codecs</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> codecs.<span class="bu">open</span>(<span class="st">'data/spam.txt'</span>, <span class="st">"r"</span>,encoding<span class="op">=</span><span class="st">'utf-8'</span>, errors<span class="op">=</span><span class="st">'ignore'</span>) <span class="im">as</span> fdata:</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    raw <span class="op">=</span> fdata.readlines()</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>vocab <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>spam <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> raw:</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    spam.append(<span class="bu">set</span>(row[:<span class="op">-</span><span class="dv">2</span>].split(<span class="st">" "</span>)))</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> word <span class="kw">in</span> spam[<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>        vocab.add(word)</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> codecs</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> codecs.<span class="bu">open</span>(<span class="st">'data/ham.txt'</span>, <span class="st">"r"</span>,encoding<span class="op">=</span><span class="st">'utf-8'</span>, errors<span class="op">=</span><span class="st">'ignore'</span>) <span class="im">as</span> fdata:</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>    raw <span class="op">=</span> fdata.readlines()</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>ham <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> raw:</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>    ham.append(<span class="bu">set</span>(row[:<span class="op">-</span><span class="dv">2</span>].split(<span class="st">" "</span>)))</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> word <span class="kw">in</span> ham[<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>        vocab.add(word)</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>vocab.add(<span class="st">"&lt;unk&gt;"</span>)</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>vocab <span class="op">=</span> <span class="bu">list</span>(vocab)</span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>w2i <span class="op">=</span> {}</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,w <span class="kw">in</span> <span class="bu">enumerate</span>(vocab):</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>    w2i[w] <span class="op">=</span> i</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_indices(<span class="bu">input</span>, l<span class="op">=</span><span class="dv">500</span>):</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">input</span>:</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="bu">len</span>(line) <span class="op">&lt;</span> l):</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>            line <span class="op">=</span> <span class="bu">list</span>(line) <span class="op">+</span> [<span class="st">"&lt;unk&gt;"</span>] <span class="op">*</span> (l <span class="op">-</span> <span class="bu">len</span>(line))</span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>            idxs <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> word <span class="kw">in</span> line:</span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>                idxs.append(w2i[word])</span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a>            indices.append(idxs)</span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> indices</span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a>spam_idx <span class="op">=</span> to_indices(spam)</span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a>ham_idx <span class="op">=</span> to_indices(ham)</span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a>train_spam_idx <span class="op">=</span> spam_idx[<span class="dv">0</span>:<span class="op">-</span><span class="dv">1000</span>]</span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a>train_ham_idx <span class="op">=</span> ham_idx[<span class="dv">0</span>:<span class="op">-</span><span class="dv">1000</span>]</span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a>test_spam_idx <span class="op">=</span> spam_idx[<span class="op">-</span><span class="dv">1000</span>:]</span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a>test_ham_idx <span class="op">=</span> ham_idx[<span class="op">-</span><span class="dv">1000</span>:]</span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a>train_data <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a>train_target <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a>test_target <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">max</span>(<span class="bu">len</span>(train_spam_idx),<span class="bu">len</span>(train_ham_idx))):</span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a>    train_data.append(train_spam_idx[i<span class="op">%</span><span class="bu">len</span>(train_spam_idx)])</span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a>    train_target.append([<span class="dv">1</span>])</span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a>    train_data.append(train_ham_idx[i<span class="op">%</span><span class="bu">len</span>(train_ham_idx)])</span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a>    train_target.append([<span class="dv">0</span>])</span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">max</span>(<span class="bu">len</span>(test_spam_idx),<span class="bu">len</span>(test_ham_idx))):</span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true" tabindex="-1"></a>    test_data.append(test_spam_idx[i<span class="op">%</span><span class="bu">len</span>(test_spam_idx)])</span>
<span id="cb66-71"><a href="#cb66-71" aria-hidden="true" tabindex="-1"></a>    test_target.append([<span class="dv">1</span>])</span>
<span id="cb66-72"><a href="#cb66-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true" tabindex="-1"></a>    test_data.append(test_ham_idx[i<span class="op">%</span><span class="bu">len</span>(test_ham_idx)])</span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true" tabindex="-1"></a>    test_target.append([<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="da4ede43" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(model, input_data, target_data, batch_size<span class="op">=</span><span class="dv">500</span>, iterations<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    criterion <span class="op">=</span> MSELoss()</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    optim <span class="op">=</span> SGD(parameters<span class="op">=</span>model.get_parameters(), alpha<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    bs <span class="op">=</span> batch_size</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    n_batches <span class="op">=</span> <span class="bu">int</span>(<span class="bu">len</span>(input_data) <span class="op">/</span> batch_size)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">iter</span> <span class="kw">in</span> <span class="bu">range</span>(iterations):</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>        iter_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> b_i <span class="kw">in</span> <span class="bu">range</span>(n_batches):</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># padding token should stay at 0</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>            model.weight.data[w2i[<span class="st">'&lt;unk&gt;'</span>]] <span class="op">*=</span> <span class="dv">0</span> </span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span> <span class="op">=</span> Tensor(input_data[b_i<span class="op">*</span>bs:(b_i<span class="op">+</span><span class="dv">1</span>)<span class="op">*</span>bs], autograd<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>            target <span class="op">=</span> Tensor(target_data[b_i<span class="op">*</span>bs:(b_i<span class="op">+</span><span class="dv">1</span>)<span class="op">*</span>bs], autograd<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>            pred <span class="op">=</span> model.forward(<span class="bu">input</span>).<span class="bu">sum</span>(<span class="dv">1</span>).sigmoid()</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion.forward(pred,target)</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>            optim.step()</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>            iter_loss <span class="op">+=</span> loss.data[<span class="dv">0</span>] <span class="op">/</span> bs</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>            sys.stdout.write(<span class="st">"</span><span class="ch">\r\t</span><span class="st">Loss:"</span> <span class="op">+</span> <span class="bu">str</span>(iter_loss <span class="op">/</span> (b_i<span class="op">+</span><span class="dv">1</span>)))</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>()</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9398ec84" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test(model, test_input, test_output):</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    model.weight.data[w2i[<span class="st">'&lt;unk&gt;'</span>]] <span class="op">*=</span> <span class="dv">0</span> </span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span> <span class="op">=</span> Tensor(test_input, autograd<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    target <span class="op">=</span> Tensor(test_output, autograd<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    pred <span class="op">=</span> model.forward(<span class="bu">input</span>).<span class="bu">sum</span>(<span class="dv">1</span>).sigmoid()</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ((pred.data <span class="op">&gt;</span> <span class="fl">0.5</span>) <span class="op">==</span> target.data).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="dcb8f60e" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Embedding(vocab_size<span class="op">=</span><span class="bu">len</span>(vocab), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>model.weight.data <span class="op">*=</span> <span class="dv">0</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> MSELoss()</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>optim <span class="op">=</span> SGD(parameters<span class="op">=</span>model.get_parameters(), alpha<span class="op">=</span><span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="48adbf83" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> train(model, train_data, train_target, iterations<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"% Correct on Test Set: "</span> <span class="op">+</span> <span class="bu">str</span>(test(model, test_data, test_target)<span class="op">*</span><span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Loss:0.037140416860871466
% Correct on Test Set: 98.65
    Loss:0.011258669226059108
% Correct on Test Set: 99.15
    Loss:0.008068268387986223
% Correct on Test Set: 99.45</code></pre>
</div>
</div>
<div id="9da8f0f1" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic Federated Learning</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>bob <span class="op">=</span> (train_data[<span class="dv">0</span>:<span class="dv">1000</span>], train_target[<span class="dv">0</span>:<span class="dv">1000</span>])</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>alice <span class="op">=</span> (train_data[<span class="dv">1000</span>:<span class="dv">2000</span>], train_target[<span class="dv">1000</span>:<span class="dv">2000</span>])</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>sue <span class="op">=</span> (train_data[<span class="dv">2000</span>:], train_target[<span class="dv">2000</span>:])</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Embedding(vocab_size<span class="op">=</span><span class="bu">len</span>(vocab), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>model.weight.data <span class="op">*=</span> <span class="dv">0</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Starting Training Round..."</span>)</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\t</span><span class="st">Step 1: send the model to Bob"</span>)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    bob_model <span class="op">=</span> train(copy.deepcopy(model), bob[<span class="dv">0</span>], bob[<span class="dv">1</span>], iterations<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\t</span><span class="st">Step 2: send the model to Alice"</span>)</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>    alice_model <span class="op">=</span> train(copy.deepcopy(model), alice[<span class="dv">0</span>], alice[<span class="dv">1</span>], iterations<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\t</span><span class="st">Step 3: Send the model to Sue"</span>)</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>    sue_model <span class="op">=</span> train(copy.deepcopy(model), sue[<span class="dv">0</span>], sue[<span class="dv">1</span>], iterations<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\t</span><span class="st">Average Everyone's New Models"</span>)</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>    model.weight.data <span class="op">=</span> (bob_model.weight.data <span class="op">+</span> <span class="op">\</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>                         alice_model.weight.data <span class="op">+</span> <span class="op">\</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>                         sue_model.weight.data)<span class="op">/</span><span class="dv">3</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\t</span><span class="st">% Correct on Test Set: "</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>          <span class="bu">str</span>(test(model, test_data, test_target)<span class="op">*</span><span class="dv">100</span>))</span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Repeat!!</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting Training Round...
    Step 1: send the model to Bob
    Loss:0.21908166249699718

    Step 2: send the model to Alice
    Loss:0.2937106899184867

    Step 3: Send the model to Sue
    Loss:0.033339966977175894

    Average Everyone's New Models
    % Correct on Test Set: 84.05

Repeat!!

Starting Training Round...
    Step 1: send the model to Bob
    Loss:0.06625367483630413

    Step 2: send the model to Alice
    Loss:0.09595374225556821

    Step 3: Send the model to Sue
    Loss:0.020290247881140743

    Average Everyone's New Models
    % Correct on Test Set: 92.25

Repeat!!

Starting Training Round...
    Step 1: send the model to Bob
    Loss:0.030819682914453833

    Step 2: send the model to Alice
    Loss:0.03580324891736099

    Step 3: Send the model to Sue
    Loss:0.015368461608470256

    Average Everyone's New Models
    % Correct on Test Set: 98.8

Repeat!!
</code></pre>
</div>
</div>
</section>
<section id="federated-learning-with-homomorphic-encryption" class="level2">
<h2 class="anchored" data-anchor-id="federated-learning-with-homomorphic-encryption">Federated learning with Homomorphic Encryption</h2>
<div id="1131b06b" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> phe</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>public_key, private_key <span class="op">=</span> phe.generate_paillier_keypair(n_length<span class="op">=</span><span class="dv">1024</span>)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co"># encrypt the number "5"</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> public_key.encrypt(<span class="dv">5</span>)</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co"># encrypt the number "3"</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> public_key.encrypt(<span class="dv">3</span>)</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="co"># add the two encrypted values</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> x <span class="op">+</span> y</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="co"># decrypt the result</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>z_ <span class="op">=</span> private_key.decrypt(z)</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The Answer: "</span> <span class="op">+</span> <span class="bu">str</span>(z_))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The Answer: 8</code></pre>
</div>
</div>
<div id="7b55661b" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Embedding(vocab_size<span class="op">=</span><span class="bu">len</span>(vocab), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>model.weight.data <span class="op">*=</span> <span class="dv">0</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co"># note that in production the n_length should be at least 1024</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>public_key, private_key <span class="op">=</span> phe.generate_paillier_keypair(n_length<span class="op">=</span><span class="dv">128</span>)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_and_encrypt(model, <span class="bu">input</span>, target, pubkey):</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    new_model <span class="op">=</span> train(copy.deepcopy(model), <span class="bu">input</span>, target, iterations<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    encrypted_weights <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> val <span class="kw">in</span> new_model.weight.data[:,<span class="dv">0</span>]:</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>        encrypted_weights.append(public_key.encrypt(val))</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    ew <span class="op">=</span> np.array(encrypted_weights).reshape(new_model.weight.data.shape)</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ew</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f38e57c4" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Starting Training Round..."</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\t</span><span class="st">Step 1: send the model to Bob"</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    bob_encrypted_model <span class="op">=</span> train_and_encrypt(copy.deepcopy(model), </span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>                                            bob[<span class="dv">0</span>], bob[<span class="dv">1</span>], public_key)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\t</span><span class="st">Step 2: send the model to Alice"</span>)</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    alice_encrypted_model <span class="op">=</span> train_and_encrypt(copy.deepcopy(model), </span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>                                              alice[<span class="dv">0</span>], alice[<span class="dv">1</span>], public_key)</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\t</span><span class="st">Step 3: Send the model to Sue"</span>)</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    sue_encrypted_model <span class="op">=</span> train_and_encrypt(copy.deepcopy(model), </span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>                                            sue[<span class="dv">0</span>], sue[<span class="dv">1</span>], public_key)</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\t</span><span class="st">Step 4: Bob, Alice, and Sue send their"</span>)</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\t</span><span class="st">encrypted models to each other."</span>)</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>    aggregated_model <span class="op">=</span> bob_encrypted_model <span class="op">+</span> <span class="op">\</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>                       alice_encrypted_model <span class="op">+</span> <span class="op">\</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>                       sue_encrypted_model</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\t</span><span class="st">Step 5: only the aggregated model"</span>)</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\t</span><span class="st">is sent back to the model owner who"</span>)</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\t</span><span class="st"> can decrypt it."</span>)</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>    raw_values <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> val <span class="kw">in</span> sue_encrypted_model.flatten():</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>        raw_values.append(private_key.decrypt(val))</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>    model.weight.data <span class="op">=</span> np.array(raw_values).reshape(model.weight.data.shape)<span class="op">/</span><span class="dv">3</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\t</span><span class="st">% Correct on Test Set: "</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>              <span class="bu">str</span>(test(model, test_data, test_target)<span class="op">*</span><span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Starting Training Round...
    Step 1: send the model to Bob
    Loss:0.21908166249699718

    Step 2: send the model to Alice
    Loss:0.2937106899184867

    Step 3: Send the model to Sue
    Loss:0.033339966977175894

    Step 4: Bob, Alice, and Sue send their
    encrypted models to each other.

    Step 5: only the aggregated model
    is sent back to the model owner who
     can decrypt it.
    % Correct on Test Set: 98.75

Starting Training Round...
    Step 1: send the model to Bob
    Loss:0.06366414053035604

    Step 2: send the model to Alice
    Loss:0.061000357913513055

    Step 3: Send the model to Sue
    Loss:0.025483920416627266

    Step 4: Bob, Alice, and Sue send their
    encrypted models to each other.

    Step 5: only the aggregated model
    is sent back to the model owner who
     can decrypt it.
    % Correct on Test Set: 99.05000000000001

Starting Training Round...
    Step 1: send the model to Bob
    Loss:0.058477976535441636

    Step 2: send the model to Alice
    Loss:0.05987976552444443

    Step 3: Send the model to Sue
    Loss:0.024763428511034752

    Step 4: Bob, Alice, and Sue send their
    encrypted models to each other.

    Step 5: only the aggregated model
    is sent back to the model owner who
     can decrypt it.
    % Correct on Test Set: 99.15</code></pre>
</div>
</div>
<div id="b2ce616f" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="63">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How would you scan this dataset with your current knowledge</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>spo2_temp_hr_df.info()</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"#"</span> <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>spo2_temp_hr_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 693 entries, 0 to 692
Data columns (total 5 columns):
 #   Column       Non-Null Count  Dtype   
---  ------       --------------  -----   
 0   Date         693 non-null    object  
 1   Instrument   693 non-null    object  
 2   Reading      693 non-null    object  
 3   Observation  693 non-null    float32 
 4   Status       693 non-null    category
dtypes: category(1), float32(1), object(3)
memory usage: 20.0+ KB
####################################################################################################</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="63">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Instrument</th>
<th data-quarto-table-cell-role="th">Reading</th>
<th data-quarto-table-cell-role="th">Observation</th>
<th data-quarto-table-cell-role="th">Status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2021/04/04 12:05:00</td>
<td>Pulse oximeter</td>
<td>HR</td>
<td>62.000000</td>
<td>Well</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2021/04/04 12:06:00</td>
<td>Pulse oximeter</td>
<td>SpO2</td>
<td>96.000000</td>
<td>Well</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2021/04/04 12:13:42</td>
<td>Thermometer</td>
<td>Temperature</td>
<td>36.700001</td>
<td>Well</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2021/10/04 09:33:00</td>
<td>Thermometer</td>
<td>Temperature</td>
<td>37.000000</td>
<td>Well</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2021/10/04 09:33:00</td>
<td>Pulse oximeter</td>
<td>HR</td>
<td>63.000000</td>
<td>Well</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cee93d5d" class="cell" data-slideshow="{&quot;slide_type&quot;:&quot;slide&quot;}" data-execution_count="64">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>spo2_temp_hr_df.Status.value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>Well       0.917749
Tired      0.056277
Allergy    0.012987
anxious    0.008658
Off        0.004329
Name: Status, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary:</h2>
<p>Definitions:<br>
* <strong>Data Privacy</strong>: segregating data and controlling access. â€œGatekeeping dataâ€<br>
* <strong>Anonymization</strong>: removing PIIs<br>
* PII information that can identify you either directly sensitive PIIs or indirect Quasi-identifiers. Non-sensitive PIIs are not dangerous but they are still personal.<br>
* <strong>Techniques</strong>:<br>
* <strong>Data Deletion</strong> - is a way of reducing load on your object storage and database. Make a solid plan and talk to legal team to advice. A retriever and a destroyer is a good start. You even save money.</p>
<pre><code>* **Masking &amp; Sampling** - storing data without column names in for instance object storage and giving a small subset still retaining properties of the original dataset.   

* **K-anonymity** - making groups that exist have similar characteristics reducing reidentification strategies.  Look into l-diversity.  
    
* **Differential privacy ML** - adding noise to your models governed by BudgetAccountant and epsilon parameter.  
    
* **PCA** - reducing dimensions of your data and still retaining the properties of the data.

* **Embeddings** - representing data in a lower dimension.   

* **Federated Learning** - training an algorithm across multiple devices or servers holding local data samples, without exchanging them.    
    
* **Federated Learning with Homomorphic Encryption** - training an algorithm across multiple devices or servers holding local data samples, without exchanging them and using homomorphic encryption to secure the data.   </code></pre>
<p>Learn more</p>
<ul>
<li><p>https://www.manning.com/books/data-privacy</p></li>
<li><p>https://ethics.fast.ai/</p></li>
<li><p>https://www.apple.com/privacy/docs/Differential_Privacy_Overview.pdf</p></li>
<li><p>https://www.manning.com/books/privacy-preserving-machine-learning</p></li>
<li><p>https://www.manning.com/books/grokking-deep-learning</p></li>
<li><p>https://www.manning.com/books/build-a-career-in-data-science</p></li>
<li><p>https://www.datacamp.com/</p></li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>